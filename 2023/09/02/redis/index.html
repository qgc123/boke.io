

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="子川">
  <meta name="keywords" content="">
  
    <meta name="description" content="1 NoSql数据库简介1.1 nosql数据库的引入1.1.1 技术的分类目前我们学过很多技术，比如： 1、解决功能性的问题：JavaSE、Jsp、servlet、Tomcat、HTML、Linux、JDBC、SVN 2、解决扩展性的问题：Struts、Spring、SpringMVC、Hibernate、Mybatis 3、解决性能的问题：NoSQL、Java线程、Hadoop、Nginx、M">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis">
<meta property="og:url" content="http://example.com/2023/09/02/redis/index.html">
<meta property="og:site_name" content="子川个人博客">
<meta property="og:description" content="1 NoSql数据库简介1.1 nosql数据库的引入1.1.1 技术的分类目前我们学过很多技术，比如： 1、解决功能性的问题：JavaSE、Jsp、servlet、Tomcat、HTML、Linux、JDBC、SVN 2、解决扩展性的问题：Struts、Spring、SpringMVC、Hibernate、Mybatis 3、解决性能的问题：NoSQL、Java线程、Hadoop、Nginx、M">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221001144631.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221001144936.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221001145625.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221001150748.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221001151443.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902075408640.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902080337054.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902080608947.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902091421724.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902092140721.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902092947240.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902093817472.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902093907056.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902094205787.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902110941189.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221001193052.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003123923.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003132028.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003145035.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003155230.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003155318.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003163833.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003164002.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003164246.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003164353.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003164715.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003164838.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003164937.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003165202.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003165420.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003165628.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003165720.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003165924.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003170120.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003170244.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003175948.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003171305.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003171658.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221003171842.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902112849915.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221004134919.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221004141847.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221004144534.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221004171957.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221004180704.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221004180829.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221004181028.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221004211921.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221004215739.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221004215333.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221004220227.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221004220351.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221004220533.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221004233837.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221004234459.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221006132124.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221006155905.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902151519367.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221006172820.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902153746240.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902154006054.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902155923831.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221006180734.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902162133335.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221006231006-1693643011635-20.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902163633612.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902163526991.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230902163547260.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221007000923.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230903071255767.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/image-20230903071625051.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221009192353.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221009200327.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221009200704.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221009221846.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221009222539.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221009223003.png">
<meta property="og:image" content="http://example.com/2023/09/02/redis/20221009231238.png">
<meta property="article:published_time" content="2023-09-01T23:46:29.000Z">
<meta property="article:modified_time" content="2023-09-03T07:14:31.555Z">
<meta property="article:author" content="子川">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2023/09/02/redis/20221001144631.png">
  
  
  
  <title>Redis - 子川个人博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>子川个人博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Redis"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-09-02 07:46" pubdate>
          2023年9月2日 早上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          80k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          664 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Redis</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="1-NoSql数据库简介"><a href="#1-NoSql数据库简介" class="headerlink" title="1 NoSql数据库简介"></a>1 NoSql数据库简介</h2><h3 id="1-1-nosql数据库的引入"><a href="#1-1-nosql数据库的引入" class="headerlink" title="1.1 nosql数据库的引入"></a>1.1 nosql数据库的引入</h3><h4 id="1-1-1-技术的分类"><a href="#1-1-1-技术的分类" class="headerlink" title="1.1.1 技术的分类"></a>1.1.1 技术的分类</h4><p>目前我们学过很多技术，比如：</p>
<p>1、解决功能性的问题：JavaSE、Jsp、servlet、Tomcat、HTML、Linux、JDBC、SVN</p>
<p>2、解决扩展性的问题：Struts、Spring、SpringMVC、Hibernate、Mybatis</p>
<p>3、解决性能的问题：NoSQL、Java线程、Hadoop、Nginx、MQ、ElasticSearch</p>
<p>我们开发一个项目，无论这个项目的业务多么复杂，无外乎就是增删改查的操作。而这些功能我们要实现，通过<strong>解决功能性的问题的技术栈</strong>就可以轻松实现。但是项目的功能不可能一成不变，项目功能会随着需求的变化不而不断的增加、修改和升级。这个时候我们就需要对项目的功能进行扩展和增强，但是对项目进行扩展和增强我们需要不影响原有代码的前提下进行，此时我们可以使用<strong>解决扩展性的问题的技术栈(框架)</strong>进行操作。为什么框架能够解决程序的扩展性问题呢?因为框架定义了一定的约束和规范，我们只需要按照这些约束和规范进行开发就可以解决项目的扩展性问题。</p>
<p>现在我们再思考一个问题，项目开发完成之后，受众用户可能会有很多。随着用户量的不断增加，此时我们需要解决项目的性能问题。今天我们学习的nosql技术就是为了解决项目性能问题的。当然解决项目性能问题的技术栈还有很多，比如多线程技术、Nginx、MQ、ElasticSearch等。</p>
<h4 id="1-1-2-web的发展过程"><a href="#1-1-2-web的发展过程" class="headerlink" title="1.1.2 web的发展过程"></a>1.1.2 web的发展过程</h4><ul>
<li>Web1.0时代</li>
</ul>
<p>在Web1.0的时代，由于数据访问量很有限，用一夫当关的高性能的单点服务器可以解决大部分问题。</p>
<p><img src="20221001144631.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<ul>
<li>Web2.0时代</li>
</ul>
<p>随着Web2.0的时代的到来，用户访问量大幅度提升，同时产生了大量的用户数据。加上后来的智能移动设备的普及，所有的互联网平台都面临了巨大的性能挑战。</p>
<p><img src="20221001144936.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<p>我们需要解决两个问题，第一个是CPU及内存的压力，第二个是IO压力。</p>
<ul>
<li>CPU及内存的压力</li>
</ul>
<p>由于一台web服务器不能应对海量用户的访问。我们可以考虑对web服务器进行冗余部署，可以根据用户的访问量部署多台。再通过Nginx对用户的访问进行负载均衡操作，将用户的访问压力分摊在不同的web服务器上。</p>
<p><img src="20221001145625.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<p>这样操作又会遇到一个问题，就是session问题。解决session的方案也有很多。</p>
<p>方案1：比如我们可以把session里面的数据存放在cookie端，以后用户每次发送请求，都可以携带cookie里面的数据到服务器。但由于cookie存放在浏览器端，如果数据是敏感数据，存放在cookie会不安全。</p>
<p>方案2：session复制。将某台服务器里面的session复制一份到其他服务器里面去。这种方案也有缺点，就是把相同的session数据存放在不同的web服务器中，容易造成数据冗余，服务器空间的浪费。</p>
<p>方案3：设置缓存数据库，将session信息存放在缓存数据库里面，缓存数据库里面的数据被所有web服务器共享。并且缓存数据库中的数据存放在内存中，读写速度也非常快。</p>
<p><img src="20221001150748.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<ul>
<li>IO压力</li>
</ul>
<p>随着项目数据的日积月累，数据库里面的数据也越来越庞大。加上用户访问量的增大，我们直接访问数据库获取数据会对数据库造成非常大的IO压力。如何解决?</p>
<p>方案1：考虑对数据库进行读写分离，水平拆分、垂直拆分。但是这种方式会破坏一定的业务规则。</p>
<p>方案2：将频繁查询的数据，放在缓存，以后我们只需要从缓存里获取数据即可，减少对数据库的访问压力。</p>
<p><img src="20221001151443.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<h3 id="1-2-nosql数据库的基本概述"><a href="#1-2-nosql数据库的基本概述" class="headerlink" title="1.2 nosql数据库的基本概述"></a>1.2 nosql数据库的基本概述</h3><h4 id="1-2-1-什么是nosql数据库"><a href="#1-2-1-什么是nosql数据库" class="headerlink" title="1.2.1 什么是nosql数据库"></a>1.2.1 什么是nosql数据库</h4><p>NoSQL(NoSQL = <strong>Not Only SQL</strong> )，意即“不仅仅是SQL”，泛指<strong>非关系型的数据库</strong>。 NoSQL 不依赖业务逻辑方式存储，而以简单的key-value模式存储。因此大大的增加了数据库的扩展能力。nosql数据库有以下特点：</p>
<ul>
<li>不遵循SQL标准。</li>
<li>不支持ACID。</li>
<li>远超于SQL的性能。</li>
</ul>
<p>那么nosql有哪些适用场景呢?</p>
<ul>
<li>对数据高并发的读写</li>
<li>海量数据的读写</li>
<li>对数据高可扩展性的</li>
</ul>
<p>当然nosql也有不适用的场景:</p>
<ul>
<li>需要事务支持</li>
<li>基于sql的结构化查询存储，处理复杂的关系,需要sql查询。</li>
</ul>
<h4 id="1-2-2-常见的nosql数据库"><a href="#1-2-2-常见的nosql数据库" class="headerlink" title="1.2.2 常见的nosql数据库"></a>1.2.2 常见的nosql数据库</h4><ul>
<li>Memcache</li>
</ul>
<p>Memcache很早出现的NoSql数据库， 数据都在内存中，<font color="red">一般不持久化。</font>支持简单的key-value模式，支持类型单一。一般是作为缓存数据库辅助持久化的数据库</p>
<ul>
<li><strong>redis</strong></li>
</ul>
<p>redis几乎覆盖了Memcached的绝大部分功能,数据都在内存中，<font color="red">支持持久化，</font>主要用作备份恢复。 除了支持简单的key-value模式，还支持<font color="red">多种数据结构</font>的存储，比如 list、set、hash、zset等。一般是作为缓存数据库辅助持久化的数据库。</p>
<ul>
<li>MongoDB</li>
</ul>
<p>MongoDB 高性能、开源、模式自由(schema free)的<strong>文档型数据库(类似于json)</strong>。数据都在内存中， 如果内存不足，把不常用的数据保存到硬盘。虽然是key-value模式，但是对value（尤其是<strong>json</strong>）提供了丰富的查询功能。MongoDB支持二进制数据及大型对象。</p>
<p>我们通过<a target="_blank" rel="noopener" href="https://db-engines.com/en/ranking。查看最新的数据库排名">https://db-engines.com/en/ranking。查看最新的数据库排名</a>:</p>
<p><img src="image-20230902075408640.png" srcset="/img/loading.gif" lazyload alt="image-20230902075408640"></p>
<h4 id="1-2-3-redis的诞生历史"><a href="#1-2-3-redis的诞生历史" class="headerlink" title="1.2.3 redis的诞生历史"></a>1.2.3 redis的诞生历史</h4><p>08年的时候有一个意大利西西里岛的小伙子，笔名antirez (htp:/linvece.org!)，创建了一个访客信息网站LLOOGG.COM。有的时候我们需要知道网站的访问情况，比如访客的IP、操作系统、浏览器、使用的搜索关键词、所在地区、访问的网页地址等等。在国内，有很多网站提供了这个功能，比如CNZZ，百度统计，国外也有谷歌的GoogleAnalytics。我们不用自己写代码去实现这个功能，只需要在全局的footer里面嵌入一段JS代码就行了，当页面被访问的时候，就会自动把访客的信息发送到这些网站统计的服务器，然后我们登录后台就可以查看数据了。<br>LLOOGG.COM提供的就是这种功能，它可以查看最多10000条的最新浏览记录。<br>这样的话，它需要为每一个网站创建一个列表(List)，不同网站的访问记录进入到不同的列表。如果列表的长度超过了用户指定的长度，它需要把最早的记录删除(先进先出)。<br>当LLOOGG.COM的用户越来越多的时候，它需要维护的列表数量也越来越多，这种记录最新的请求和删除最早的请求的操作也越来越多。LLOOGG.COM最初使用的数据库是MySQL，可想而知，因为每一次记录和删除都要读写磁盘，因为数据量和并发量太大，在这种情况下无论怎么去优化数据库都不管用了。<br>考虑到最终限制数据库性能的瓶颈在于磁盘，所以antirez打算放弃磁盘，自己去实现一个具有列表结构的数据库的原型，把数据放在内存而不是磁盘，这样可以大大地提升列表的push和pop的效率。antrez发现这种思路确实能解决这个问题，所以用C语言重写了这个内存数据库，并且加上了持久化的功能，09年，Redis横空出世了。从最开始只支持列表的数据库，到现在支持多种数据类型，并且提供了一系列的高级特性，Redis已经成为一个在全世界被广泛使用的开源项目。<br>为什么叫REDIS呢?它的全称是REmote Dlctionary Service，直接翻译过来是远程字典服务。</p>
<h2 id="2-redis的概述和安装"><a href="#2-redis的概述和安装" class="headerlink" title="2 redis的概述和安装"></a>2 redis的概述和安装</h2><h3 id="2-1-redis的概述"><a href="#2-1-redis的概述" class="headerlink" title="2.1 redis的概述"></a>2.1 redis的概述</h3><ul>
<li><p>Redis是一个开源的key-value存储系统。</p>
</li>
<li><p>和Memcached类似，它支持存储的value类型相对更多，包括string(字符串)、list(链表)、set(集合)、zset(sorted set —有序集合)和hash（哈希类型）。</p>
</li>
<li><p>这些数据类型都支持push/pop、add/remove及取交集并集和差集及更丰富的操作，而且这些操作都是原子性的。</p>
</li>
<li><p>在此基础上，Redis支持各种不同方式的排序。</p>
</li>
<li><p>与memcached一样，为了保证效率，数据都是缓存在内存中。</p>
</li>
<li><p>区别的是Redis会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件。</p>
</li>
<li><p>并且在此基础上实现了master-slave(主从)同步。</p>
</li>
</ul>
<p>基于这些特性，redis的使用场景非常广泛：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>场景</th>
<th>解决方案</th>
</tr>
</thead>
<tbody>
<tr>
<td>获取最新数据</td>
<td>通过List实现按自然时间排序的数据</td>
</tr>
<tr>
<td>排行榜</td>
<td>利用Zset有序集合</td>
</tr>
<tr>
<td>时效性的数据，比如手机验证码</td>
<td>Expire过期</td>
</tr>
<tr>
<td>计数器、秒杀</td>
<td>原子性 自增方法INCR  DECR</td>
</tr>
<tr>
<td>去除大量数据中的重复数据</td>
<td>利用Set集合</td>
</tr>
<tr>
<td>构建队列</td>
<td>List集合</td>
</tr>
<tr>
<td>发布订阅消息系统</td>
<td>pub/sub模式</td>
</tr>
</tbody>
</table>
</div>
<h3 id="2-2-redis的安装"><a href="#2-2-redis的安装" class="headerlink" title="2.2 redis的安装"></a>2.2 redis的安装</h3><p>我们可以在官网上下载redis。redis的官网:<a target="_blank" rel="noopener" href="https://redis.io。">https://redis.io。</a></p>
<p><img src="image-20230902080337054.png" srcset="/img/loading.gif" lazyload alt="image-20230902080337054"></p>
<p>我的百度云了redis的安装包，大家可以在百度云里面自行下载：：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs txt">链接：https://pan.baidu.com/s/1AXUsqV4js6Nw4ARObZDmqA <br>提取码：mj6a<br></code></pre></td></tr></table></figure>
<p>里面分别是linux版本，windows版本和压缩包版本</p>
<p><img src="image-20230902080608947.png" srcset="/img/loading.gif" lazyload alt="image-20230902080608947"></p>
<h4 id="2-2-1-前期准备"><a href="#2-2-1-前期准备" class="headerlink" title="2.2.1 前期准备"></a>2.2.1 前期准备</h4><ul>
<li><p><strong>linux操作系统：</strong></p>
<ul>
<li><p>redis安装包：redis-6.2.1.tar.gz。</p>
</li>
<li><p>gcc编译器</p>
</li>
</ul>
</li>
<li><p><strong>windows操作系统：</strong></p>
<ul>
<li>redis安装包：Redis-x64-3.0.504.msi</li>
</ul>
</li>
</ul>
<h4 id="2-2-2-安装步骤"><a href="#2-2-2-安装步骤" class="headerlink" title="2.2.2 安装步骤"></a>2.2.2 安装步骤</h4><h5 id="linux操作系统："><a href="#linux操作系统：" class="headerlink" title="linux操作系统："></a><strong>linux操作系统：</strong></h5><ul>
<li>下载安装最新版的gcc编译器</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine opt]~$ gcc --version  # 通过查看gcc版本，查看本机linux系统里面是否安装gcc工具<br>bash: gcc: 未找到命令...<br>[qgc@qgc-virtual-machine opt]~$ yum install gcc  # 安装gcc编译工具<br>[qgc@qgc-virtual-machine opt]~$ gcc --version  # 安装完成之后 再次查看gcc编译工具版本<br>gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-44)<br>Copyright © 2015 Free Software Foundation, Inc.<br>本程序是自由软件；请参看源代码的版权声明。本软件没有任何担保；<br>包括没有适销性和某一专用目的下的适用性担保。<br></code></pre></td></tr></table></figure>
<ul>
<li>将redis安装包上传至/opt目录</li>
</ul>
<p>这一步就是想办法把你的redis安装包上传到linux上，有人用的ssh可视化工具，这个仁者见仁智者见智，我用的ssh的scp，步骤如下：</p>
<p>1）linux端用ifconfig命令查看网络,（inet 地址：<em> </em> <em> ………</em>就是我们要连接的ip）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">qgc@qgc-virtual-machine:~$ ifconfig<br>ens32     Link encap:以太网  硬件地址 00:0c:29:7d:b7:71  <br>          inet 地址:192.168.84.128  广播:192.168.84.255  掩码:255.255.255.0<br>          inet6 地址: fe80::acf8:e9e:e906:e094/64 Scope:Link<br>          UP BROADCAST RUNNING MULTICAST  MTU:1500  跃点数:1<br>          接收数据包:28233 错误:0 丢弃:0 过载:0 帧数:0<br>          发送数据包:2651 错误:0 丢弃:0 过载:0 载波:0<br>          碰撞:0 发送队列长度:1000 <br>          接收字节:40665365 (40.6 MB)  发送字节:205420 (205.4 KB)<br><br>lo        Link encap:本地环回  <br>          inet 地址:127.0.0.1  掩码:255.0.0.0<br>          inet6 地址: ::1/128 Scope:Host<br>          UP LOOPBACK RUNNING  MTU:65536  跃点数:1<br>          接收数据包:369 错误:0 丢弃:0 过载:0 帧数:0<br>          发送数据包:369 错误:0 丢弃:0 过载:0 载波:0<br>          碰撞:0 发送队列长度:1000 <br>          接收字节:34193 (34.1 KB)  发送字节:34193 (34.1 KB)<br></code></pre></td></tr></table></figure>
<p>如上192.168.84.128就是我们要连接的ip</p>
<p>2）window端使用scp：</p>
<p>找到自己的redis安装包地址，如我的是：”C:\Users\Administrator\Desktop\‎\学习\个人学习\redis\redis软件\redis-6.2.1.tar.gz”</p>
<p>然后具体操作如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">PS C:\Windows\System32\WindowsPowerShell\v1.0&gt; 输入# scp &quot;C:\Users\Administrator\Desktop\‎\学习\个人学习\redis\redis软件\redis-6.2.1.tar.gz&quot; qgc@192.168.84.128:<br><br>输出：<br>qgc@192.168.84.128&#x27;s password:输入你的linux系统密码<br>redis-6.2.1.tar.gz                                                                    100% 2381KB  39.4MB/s   00:00<br></code></pre></td></tr></table></figure>
<p>至此安装包上传完毕。</p>
<ul>
<li><p>解压redis安装包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">qgc@qgc-virtual-machine:~$ tar -zxvf redis-6.2.1.tar.gz<br>qgc@qgc-virtual-machine:~$ ll<br>总用量 2516<br>drwxrwxr-x  7 qgc  qgc     4096 3月   2  2021 redis-6.2.1/ # 解压之后的目录<br>-rw-rw-r--  1 qgc  qgc  2438367 9月   2 09:05 redis-6.2.1.tar.gz<br></code></pre></td></tr></table></figure>
</li>
</ul>
<p>  注意：<strong>如果没有准备好C语言编译环境，make 会报错—Jemalloc/jemalloc.h：没有那个文件</strong></p>
<p>  解决方案: 先准备好gcc环境，然后执行如下命令：</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">qgc@qgc-virtual-machine:~$  make distclean  # 清除执行编译的c文件<br>qgc@qgc-virtual-machine:~$  make  # 再次执行make操作<br></code></pre></td></tr></table></figure>
<ul>
<li><p>进入redis安装目录，执行make指令进行编译</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">qgc@qgc-virtual-machine:~$ cd redis-6.2.1/<br>qgc@qgc-virtual-machine:~$ make<br></code></pre></td></tr></table></figure>
<p>完成后最后输出如图：</p>
<p><img src="image-20230902091421724.png" srcset="/img/loading.gif" lazyload alt="image-20230902091421724"></p>
</li>
<li><p>编译之后，执行安装命令</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">qgc@qgc-virtual-machine:~$ sudo make install<br>cd src &amp;&amp; make install<br>make[1]: 进入目录“/opt/redis-6.2.1/src”<br>    CC Makefile.dep<br>make[1]: 离开目录“/opt/redis-6.2.1/src”<br>make[1]: 进入目录“/opt/redis-6.2.1/src”<br><br>Hint: It&#x27;s a good idea to run &#x27;make test&#x27; ;)<br><br>    INSTALL install<br>    INSTALL install<br>    INSTALL install<br>make[1]: 离开目录“/opt/redis-6.2.1/src”<br></code></pre></td></tr></table></figure>
<p>注意：<strong>安装成功之后，默认的安装目录是/usr/local/bin</strong>。我们可以去查看具体的安装详情：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">qgc@qgc-virtual-machine:~$ cd /usr/local/bin<br>qgc@qgc-virtual-machine:~$ ll<br>总用量 14336<br>drwxr-xr-x  2 root root    4096 9月   2 09:16 ./<br>drwxr-xr-x 10 root root    4096 2月  27  2019 ../<br>-rwxr-xr-x  1 root root 3553580 9月   2 09:16 redis-benchmark*<br>lrwxrwxrwx  1 root root      12 9月   2 09:16 redis-check-aof -&gt; redis-server*<br>lrwxrwxrwx  1 root root      12 9月   2 09:16 redis-check-rdb -&gt; redis-server*<br>-rwxr-xr-x  1 root root 3747576 9月   2 09:16 redis-cli*<br>lrwxrwxrwx  1 root root      12 9月   2 09:16 redis-sentinel -&gt; redis-server*<br>-rwxr-xr-x  1 root root 7367928 9月   2 09:16 redis-server*<br></code></pre></td></tr></table></figure>
<p>这里我们简单了解这几个文件的用途：</p>
<ul>
<li>redis-benchmark:性能测试工具，可以在自己本子运行，看看自己本子性能如何</li>
<li>redis-check-aof：修复有问题的AOF文件，rdb和aof后面讲</li>
<li>redis-check-dump：修复有问题的dump.rdb文件</li>
<li>redis-sentinel：Redis集群使用</li>
<li>redis-server：Redis服务器启动命令</li>
<li>redis-cli：客户端，操作入口</li>
</ul>
<h5 id="window安装"><a href="#window安装" class="headerlink" title="window安装"></a>window安装</h5><p>直接双击Redis-x64-3.0.504.msi文件，然后一直下一步就可以啦！！！</p>
<h3 id="2-3-redis启动"><a href="#2-3-redis启动" class="headerlink" title="2.3 redis启动"></a>2.3 redis启动</h3><h4 id="2-3-1-redis前台启动-不推荐"><a href="#2-3-1-redis前台启动-不推荐" class="headerlink" title="2.3.1 redis前台启动(不推荐)"></a>2.3.1 redis前台启动(不推荐)</h4><p>前台启动，命令行窗口不能关闭，否则服务器停止。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">qgc@qgc-virtual-machine:~$ redis-server<br></code></pre></td></tr></table></figure>
<p><img src="image-20230902092140721.png" srcset="/img/loading.gif" lazyload alt="image-20230902092140721"></p>
<h4 id="2-3-2-redis后台启动-推荐"><a href="#2-3-2-redis后台启动-推荐" class="headerlink" title="2.3.2 redis后台启动(推荐)"></a>2.3.2 redis后台启动(推荐)</h4><ul>
<li>进入redis的解压目录，拷贝一份redis.conf配置文件到redis安装目录</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">qgc@qgc-virtual-machine:~$ cd redis-6.2.1/<br>qgc@qgc-virtual-machine:~$ sudo cp redis.conf /usr/local/bin<br>qgc@qgc-virtual-machine:~$ cd /usr/local/bin<br>qgc@qgc-virtual-machine:~$ ll<br></code></pre></td></tr></table></figure>
<p><img src="image-20230902092947240.png" srcset="/img/loading.gif" lazyload alt="image-20230902092947240"></p>
<ul>
<li>编辑redis.conf配置文件，<strong>后台启动设置daemonize no改成yes</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">qgc@qgc-virtual-machine:~$ vim redis.conf<br></code></pre></td></tr></table></figure>
<ul>
<li>启动redis</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">qgc@qgc-virtual-machine:~$ redis-server redis.conf <br>qgc@qgc-virtual-machine:~$ ps -ef | grep redis  # 查看redis的服务进程<br>qgc       9130  1016  0 09:18 ?        00:00:02 redis-server *:6379<br>qgc       9919  9208  0 09:43 pts/18   00:00:00 grep --color=auto redis<br></code></pre></td></tr></table></figure>
<ul>
<li>使用客户端连接redis</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">qgc@qgc-virtual-machine:~$ redis-cli # 使用redis自带客户端连接redis<br>127.0.0.1:6379&gt; ping  # 查看是否ping通redis服务器<br>PONG<br></code></pre></td></tr></table></figure>
<ul>
<li>关闭redis服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">qgc@qgc-virtual-machine:~$ redis-cli shutdown  # 关闭redis服务<br>qgc@qgc-virtual-machine:~$ ps -ef | grep redis<br>qgc      10160  9208  0 10:05 pts/18   00:00:00 grep --color=auto redis<br></code></pre></td></tr></table></figure>
<p>关闭错误参考文档：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_46127735/article/details/113933690">Redis关闭服务错误——(error) ERR Errors trying to SHUTDOWN. Check logs._、以吾之名的博客-CSDN博客</a></p>
<p>如果reids是多实例，，也可以指定端口关闭：redis-cli -p 6379 shutdown</p>
<ul>
<li><p>开放redis端口号6379的远程访问权限</p>
<ul>
<li><p>修改配置文件注释掉如下内容</p>
<p><img src="image-20230902093817472.png" srcset="/img/loading.gif" lazyload alt="image-20230902093817472"></p>
</li>
<li><p>关闭本地防护：</p>
<p>改前：</p>
</li>
</ul>
</li>
</ul>
<p><img src="image-20230902093907056.png" srcset="/img/loading.gif" lazyload alt="image-20230902093907056"></p>
<p>​                改后：</p>
<p><img src="image-20230902094205787.png" srcset="/img/loading.gif" lazyload alt="image-20230902094205787"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">qgc@qgc-virtual-machine:~$ firewall-cmd --permanent --add-port=6379/tcp<br>success<br>qgc@qgc-virtual-machine:~$ firewall-cmd --reload<br>success<br>qgc@qgc-virtual-machine:~$ firewall-cmd --list-ports<br>3306/tcp 8080/tcp 6379/tcp<br></code></pre></td></tr></table></figure>
<p>至于视图工具参考（我用的Navicat16）：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ssmushui/p/17556189.html">Navicat最新162激活破解 - 山石木水 - 博客园 (cnblogs.com)</a></p>
<p>连接成功如图</p>
<p><img src="image-20230902110941189.png" srcset="/img/loading.gif" lazyload alt="image-20230902110941189"></p>
<h3 id="2-4-redis的相关知识"><a href="#2-4-redis的相关知识" class="headerlink" title="2.4 redis的相关知识"></a>2.4 redis的相关知识</h3><ul>
<li>为什么redis的端口号是6379?</li>
</ul>
<p><img src="20221001193052.png" srcset="/img/loading.gif" lazyload style="zoom:60%"></p>
<p>6379在是手机按键上MERZ对应的号码，而MERZ取自意大利歌女Alessia Merz的名字。</p>
<p>Alessia Merz 是一位意大利舞女、女演员。 Redis 作者 Antirez 早年看电视节目，觉得 Merz 在节目中的一些话愚蠢可笑，Antirez 喜欢造“梗”用于平时和朋友们交流，于是造了一个词 “MERZ”，形容愚蠢，与 “stupid” 含义相同。MERZ长期以来被Redis作者antirez及其朋友当作愚蠢的代名词。</p>
<p>后来 Antirez 重新定义了 “MERZ” ，形容”具有很高的技术价值，包含技艺、耐心和劳动，但仍然保持简单本质“。</p>
<p>到了给 Redis 选择一个数字作为默认端口号时，Antirez 没有多想，把 “MERZ” 在手机键盘上对应的数字 6379 拿来用了。</p>
<ul>
<li>redis默认的数据库实例</li>
</ul>
<p>默认16个数据库，类似数组下标从0开始，初始默认使用0号库。使用命令 <code>select  &lt;dbid&gt;</code>来切换数据库。如: select 8 。dbsize查看当前数据库的key的数量。flushdb清空当前库。</p>
<ul>
<li>Redis是单线程+多路IO复用技术</li>
</ul>
<p>多路复用是指使用一个线程来检查多个文件描述符（Socket）的就绪状态，比如调用select和poll函数，传入多个文件描述符，如果有一个文件描述符就绪，则返回，否则阻塞直到超时。得到就绪状态后进行真正的操作可以在同一个线程里执行，也可以启动线程执行（比如使用线程池）</p>
<p><strong>memcached：串行  vs  多线程+锁</strong></p>
<p> <strong>redis: 单线程+多路IO复用(Redis)</strong></p>
<h2 id="3-redis常用数据类型操作"><a href="#3-redis常用数据类型操作" class="headerlink" title="3 redis常用数据类型操作"></a>3 redis常用数据类型操作</h2><h3 id="3-1-redis基于key-键-的操作"><a href="#3-1-redis基于key-键-的操作" class="headerlink" title="3.1 redis基于key(键)的操作"></a>3.1 redis基于key(键)的操作</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; keys *   # 查看当前数据库中所有的key值<br>(empty array)<br>127.0.0.1:6379&gt; set k1 eric  # 设置key值 值是string类型<br>OK<br>127.0.0.1:6379&gt; set k2 james<br>OK<br>127.0.0.1:6379&gt; set k3 kobe<br>OK<br>127.0.0.1:6379&gt; keys *<br>1) &quot;k1&quot;<br>2) &quot;k3&quot;<br>3) &quot;k2&quot;<br>127.0.0.1:6379&gt; type k2  # 查看指定key的数据类型<br>string <br>127.0.0.1:6379&gt; exists k1  # 判断指定的key是否存在  存在就为1 不存在就为0<br>(integer) 1<br>127.0.0.1:6379&gt; exists k4<br>(integer) 0<br>127.0.0.1:6379&gt; del key k3  # 删除指定的key值<br>(integer) 1<br>127.0.0.1:6379&gt; keys *<br>1) &quot;k1&quot;<br>2) &quot;k2&quot;<br>127.0.0.1:6379&gt; expire k1 10  # 给key设置过期时间<br>(integer) 1<br>127.0.0.1:6379&gt; ttl k1  # 查看指定key值的存活时期 不存在就为负数<br>(integer) 6<br>127.0.0.1:6379&gt; ttl k1<br>(integer) -2<br>127.0.0.1:6379&gt; select 0  # 切换到指定的数据库<br>OK<br>127.0.0.1:6379&gt; dbsize  # 查看当前数据库的key的数量<br>(integer) 1<br>127.0.0.1:6379&gt; flushdb  # 清空当前数据库<br>OK<br>127.0.0.1:6379&gt; flushall  # 清空所有的数据库<br>OK<br></code></pre></td></tr></table></figure>
<h3 id="3-2-redis中string的操作"><a href="#3-2-redis中string的操作" class="headerlink" title="3.2 redis中string的操作"></a>3.2 redis中string的操作</h3><h4 id="3-2-1-redis中string的介绍"><a href="#3-2-1-redis中string的介绍" class="headerlink" title="3.2.1 redis中string的介绍"></a>3.2.1 redis中string的介绍</h4><p>String是Redis最基本的类型，你可以理解成与Memcached一模一样的类型，一个key对应一个value。String类型是二进制安全的。意味着Redis的string可以包含任何数据。比如jpg图片或者序列化的对象。String类型是Redis最基本的数据类型，一个Redis中字符串value最多可以是512M。</p>
<h4 id="3-2-2-redis中string的常用命令"><a href="#3-2-2-redis中string的常用命令" class="headerlink" title="3.2.2 redis中string的常用命令"></a>3.2.2 redis中string的常用命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; keys *<br>(empty array)<br>127.0.0.1:6379&gt; set k1 eric  # 给key设置String类型的值<br>OK<br>127.0.0.1:6379&gt; set k2 kobe<br>OK<br>127.0.0.1:6379&gt; get k1  # 根据key获取对象的value值<br>&quot;eric&quot;<br>127.0.0.1:6379&gt; get k2<br>&quot;kobe&quot;<br>127.0.0.1:6379&gt; set k1 james # 如果给一个已经存在的key设置值就是覆盖原来的值<br>OK<br>127.0.0.1:6379&gt; get k1<br>&quot;james&quot;<br>127.0.0.1:6379&gt; append k1 123 # 在指定key的值后面追加内容<br>(integer) 8  # 追加之后字符串的长度<br>127.0.0.1:6379&gt; get k1<br>&quot;james123&quot;<br>127.0.0.1:6379&gt; strlen k1  # 获取key的长度<br>(integer) 8<br>127.0.0.1:6379&gt; setnx k1 miller # 当可以不存在时 value才会设置成功，否则设置不成功<br>(integer) 0  # 0 标识没有设置成功<br>127.0.0.1:6379&gt; get k1  # k1的值没有发生变化，因为key已经存在<br>&quot;james123&quot;<br>127.0.0.1:6379&gt; setnx k3 curry  # k3的值设置成功，因为之前不存在key3这个键<br>(integer) 1   # 1 标识设置成功<br>127.0.0.1:6379&gt; get k3<br>&quot;curry&quot;<br>127.0.0.1:6379&gt; set num1 100  <br>OK<br>127.0.0.1:6379&gt; incr num1 # incr命令操作的值必须是数字类型  incr:对key自增1<br>(integer) 101<br>127.0.0.1:6379&gt; get num1<br>&quot;101&quot;<br>127.0.0.1:6379&gt; decr num1 # 对key进行自减操作<br>(integer) 100<br>127.0.0.1:6379&gt; get num1<br>&quot;100&quot;<br>127.0.0.1:6379&gt; incrby num1 5  # 对key进行增加 指定增加5<br>(integer) 105<br>127.0.0.1:6379&gt; decrby num1 10  # 对key进行递减 指定减去5<br>(integer) 95<br></code></pre></td></tr></table></figure>
<p><strong>注意:</strong></p>
<p><strong>incr命令是原子操作。</strong>也就是指不会被线程调度机制打断的操作。这种操作一旦开始，就一直运行到结束，中间不会有任何线程上下文切换。在单线程中， 能够在单条指令中完成的操作都可以认为是”原子操作”。</p>
<p><strong>问题：</strong></p>
<p><strong>Java中的i++属于原子性操作吗?  不是</strong></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs txt">i++; 不是原子操作<br>第一步：取值  i = 0;<br>第二步：自加操作 i++;<br>第三步：将自加的操作结果赋予给i。<br></code></pre></td></tr></table></figure>
<p><strong>i = 0，两个线程对i分别进行i++100次。值是多少?(2-200)</strong></p>
<p>首先在两个线程互不干扰的情况下，分别对i++执行，一个线程执行完再执行另一个线程，这样就会使i自增200次，即最终为200，这是理想状态下的互不干涉，最坏情况则为，第一个线程执行了99次，当A线程的i++执行到99次时，此时cpu1寄存器中值为99，内存为99</p>
<p>当B线程cpu2寄存器的1，写回内存覆盖内存的99，变成1</p>
<p>如果可以这样，那A线程也可以同样再覆盖一次B线程，最终结果就是2。</p>
<p>redis操作string的其他命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; mset k1 v1 k2 v2 k3 v3  # 批量设置k-v<br>OK<br>127.0.0.1:6379&gt; mget k1 k2 k3 # 批量获取值<br>1) &quot;v1&quot;<br>2) &quot;v2&quot;<br>3) &quot;v3&quot;<br>127.0.0.1:6379&gt; msetnx k1 v11 k5 v5  # 只有所有的key都不存在，才会设置，任意一个key存在，都不会设置值<br>(integer) 0<br>127.0.0.1:6379&gt; msetnx k4 v4 k5 v5<br>(integer) 1<br>127.0.0.1:6379&gt; mget k4 k5<br>1) &quot;v4&quot;<br>2) &quot;v5&quot;<br>127.0.0.1:6379&gt; set name LebronJames<br>OK<br>127.0.0.1:6379&gt; getrange name 0 6  #根据指定区间获取字符串的值 索引值从0开始<br>&quot;LebronJ&quot;<br>127.0.0.1:6379&gt; getrange name 0 5<br>&quot;Lebron&quot;<br>127.0.0.1:6379&gt; setrange name 0 kobe  # 从指定索引值开始替换值<br>(integer) 11<br>127.0.0.1:6379&gt; get name<br>&quot;kobeonJames&quot;<br>127.0.0.1:6379&gt; setex k6 20 v6  # 设置key的值的同时，也设置过期时间<br>OK<br>127.0.0.1:6379&gt; ttl k6<br>(integer) 16<br>127.0.0.1:6379&gt; get name<br>&quot;kobeonJames&quot;<br>127.0.0.1:6379&gt; getset name green  # 使用新值替换旧值，但是返回旧值 <br>&quot;kobeonJames&quot;<br>127.0.0.1:6379&gt; get name<br>&quot;green&quot;<br></code></pre></td></tr></table></figure>
<h3 id="3-3-redis中list的操作"><a href="#3-3-redis中list的操作" class="headerlink" title="3.3 redis中list的操作"></a>3.3 redis中list的操作</h3><p>List列表是单键多值的列表。Redis 列表是简单的字符串列表，按照插入顺序排序。你可以添加一个元素到列表的头部（左边）或者尾部（右边）。它的底层实际是个双向链表，对两端的操作性能很高，但是通过索引下标操作中间的节点性能会较差。</p>
<p><img src="20221003123923.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<h4 id="3-3-1-list的常用命令"><a href="#3-3-1-list的常用命令" class="headerlink" title="3.3.1 list的常用命令"></a>3.3.1 list的常用命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; lpush k1 v1 v2 v3  # 从列表的左边追加元素 键是k1 值是v1 v2 v3<br>(integer) 3<br>127.0.0.1:6379&gt; lrange k1 0 -1  # 查询列表中的所有元素<br>1) &quot;v3&quot;<br>2) &quot;v2&quot;<br>3) &quot;v1&quot;<br>127.0.0.1:6379&gt; rpush k1 v4 v5 v6  # 从列表的右边追加元素 键是k1 值是v4 v5 v6<br>(integer) 6<br>127.0.0.1:6379&gt; lrange k1 0 -1<br>1) &quot;v3&quot;<br>2) &quot;v2&quot;<br>3) &quot;v1&quot;<br>4) &quot;v4&quot;<br>5) &quot;v5&quot;<br>6) &quot;v6&quot;<br>127.0.0.1:6379&gt; lpop k1  # 从左边弹出一个值并返回<br>&quot;v3&quot;<br>127.0.0.1:6379&gt; rpop k1  # 从右边弹出一个值并返回<br>&quot;v6&quot;<br>127.0.0.1:6379&gt; lpush k2 s1 s2 s3   # 创建k2列表 并追加值<br>(integer) 3<br>127.0.0.1:6379&gt; lrange k2 0 -1<br>1) &quot;s3&quot;<br>2) &quot;s2&quot;<br>3) &quot;s1&quot;<br>127.0.0.1:6379&gt; lrange k1 0 -1<br>1) &quot;v2&quot;<br>2) &quot;v1&quot;<br>3) &quot;v4&quot;<br>4) &quot;v5&quot;<br>127.0.0.1:6379&gt; rpoplpush k1 k2 # 将k1列表最右边的值取出来,追加到k2列表的最左边<br>&quot;v5&quot;<br>127.0.0.1:6379&gt; lrange k1 0 -1  # k1最右边的元素没有了<br>1) &quot;v2&quot;<br>2) &quot;v1&quot;<br>3) &quot;v4&quot;<br>127.0.0.1:6379&gt; lrange k2 0 -1  # 查看k2集合 k2元素的最左边追加了元素v5<br>1) &quot;v5&quot;<br>2) &quot;s3&quot;<br>3) &quot;s2&quot;<br>4) &quot;s1&quot;<br>127.0.0.1:6379&gt; lindex k2 2  # 根据指定下标获取元素<br>&quot;s2&quot;<br>127.0.0.1:6379&gt; llen k2  # 获取指定列表的长度<br>(integer) 4<br>127.0.0.1:6379&gt; linsert k2 before s2  v2  # 在k2列表中的s2元素前面追加元素v2<br>(integer) 5<br>127.0.0.1:6379&gt; lrange k2 0 -1<br>1) &quot;v5&quot;<br>2) &quot;s3&quot;<br>3) &quot;v2&quot;<br>4) &quot;s2&quot;<br>5) &quot;s1&quot;<br>127.0.0.1:6379&gt; lrem k2 1 s2  # 从左边删除指定个数的元素s2<br>(integer) 1<br>127.0.0.1:6379&gt; lrange k2 0 -1<br>1) &quot;v5&quot;<br>2) &quot;s3&quot;<br>3) &quot;v2&quot;<br>4) &quot;s1&quot;<br>127.0.0.1:6379&gt; lset k2 2 s2  # 将指定索引位置上的元素替换(将k2列表中2号索引位置上的元素替换成s2)<br>OK<br>127.0.0.1:6379&gt; lrange k2 0 -1<br>1) &quot;v5&quot;<br>2) &quot;s3&quot;<br>3) &quot;s2&quot;<br>4) &quot;s1&quot;<br></code></pre></td></tr></table></figure>
<h4 id="3-3-2-list的数据结构"><a href="#3-3-2-list的数据结构" class="headerlink" title="3.3.2 list的数据结构"></a>3.3.2 list的数据结构</h4><p>List的数据结构为快速链表quickList。</p>
<p>首先在列表元素较少的情况下会使用一块连续的内存存储，这个结构是ziplist，也即是压缩列表。它将所有的元素紧挨着一起存储，分配的是一块连续的内存。</p>
<p>当数据量比较多的时候才会改成quicklist。</p>
<p>因为普通的链表需要的附加指针空间太大，会比较浪费空间。比如这个列表里存的只是int类型的数据，结构上还需要两个额外的指针prev和next。</p>
<p>Redis将链表和ziplist结合起来组成了quicklist。也就是将多个ziplist使用双向指针串起来使用。这样既满足了快速的插入删除性能，又不会出现太大的空间冗余。</p>
<p><img src="20221003132028.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<h3 id="3-4-redis中的set操作"><a href="#3-4-redis中的set操作" class="headerlink" title="3.4 redis中的set操作"></a>3.4 redis中的set操作</h3><p>Redis set对外提供的功能与list类似是一个列表的功能，特殊之处在于set是可以<strong>自动去重</strong>的，当你需要存储一个列表数据，又不希望出现重复数据时，set是一个很好的选择，并且set提供了判断某个成员是否在一个set集合内的命令，这个也是list所不能提供的。</p>
<p>Redis的Set是string类型的无序集合。它底层其实是一个value为null的hash表，所以添加，删除，查找的<strong>复杂度都是</strong> <strong>O(1)</strong>。(随着数据的增加，执行时间的长短，如果是O(1)，数据增加，查找数据的时间不变)</p>
<h4 id="3-4-1-set的常用命令"><a href="#3-4-1-set的常用命令" class="headerlink" title="3.4.1 set的常用命令"></a>3.4.1 set的常用命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; sadd s1 v1 v2 v3  # 向s1中添加元素 v1 v2 v3<br>(integer) 3<br>127.0.0.1:6379&gt; smembers s1  # 查询列表中的所有元素<br>1) &quot;v2&quot;<br>2) &quot;v3&quot;<br>3) &quot;v1&quot;<br>127.0.0.1:6379&gt; sadd s1 v3  # 添加重复元素 没有添加成功<br>(integer) 0<br>127.0.0.1:6379&gt; smembers s1<br>1) &quot;v2&quot;<br>2) &quot;v3&quot;<br>3) &quot;v1&quot;<br>127.0.0.1:6379&gt; sismember s1 v1 # 判断集合是否存在某个元素 存在返回1 不存在返回0<br>(integer) 1<br>127.0.0.1:6379&gt; sismember s1 v7<br>(integer) 0<br>127.0.0.1:6379&gt; scard s1  # 返回集合中元素的个数<br>(integer) 3<br>127.0.0.1:6379&gt; srem s1 v1 v2  # 删除集合中指定的元素<br>(integer) 2<br>127.0.0.1:6379&gt; smembers s1<br>1) &quot;v3&quot;<br>127.0.0.1:6379&gt; spop s1  # 随机弹出集合中的某个元素<br>&quot;v4&quot;<br>127.0.0.1:6379&gt; smembers s1<br>1) &quot;v2&quot;<br>2) &quot;v3&quot;<br>3) &quot;v5&quot;<br>127.0.0.1:6379&gt; srandmember s1 2  # 随机弹出指定个数的元素,但是不会从集合中删除<br>1) &quot;v2&quot;<br>2) &quot;v3&quot;<br>127.0.0.1:6379&gt; smembers s1<br>1) &quot;v2&quot;<br>2) &quot;v3&quot;<br>3) &quot;v5&quot;<br>127.0.0.1:6379&gt; smove s1 s2 v5  # 将s1集合中的元素s5移动到s2集合中去。<br>(integer) 1<br>127.0.0.1:6379&gt; smembers s1<br>1) &quot;v3&quot;<br>127.0.0.1:6379&gt; smembers s2<br>1) &quot;v2&quot;<br>2) &quot;v3&quot;<br>3) &quot;v5&quot;<br>4) &quot;v1&quot;<br>127.0.0.1:6379&gt; sinter s1 s2  # 取集合s1 s2的交集<br>1) &quot;v3&quot;<br>127.0.0.1:6379&gt; sunion s1 s2 # 取集合s1 s2的并集<br>1) &quot;v2&quot;<br>2) &quot;v3&quot;<br>3) &quot;v5&quot;<br>4) &quot;v1&quot;<br>127.0.0.1:6379&gt; sdiff s2 s1  # 取s2的补集<br>1) &quot;v2&quot;<br>2) &quot;v5&quot;<br>3) &quot;v1&quot;<br></code></pre></td></tr></table></figure>
<h4 id="3-4-2-set的数据结构"><a href="#3-4-2-set的数据结构" class="headerlink" title="3.4.2 set的数据结构"></a>3.4.2 set的数据结构</h4><p>Set数据结构是dict字典，字典是用哈希表实现的。</p>
<p>Java中HashSet的内部实现使用的是HashMap，只不过所有的value都指向同一个对象。Redis的set结构也是一样，它的内部也使用hash结构，所有的value都指向同一个内部值。</p>
<h3 id="3-5-redis中的hash操作"><a href="#3-5-redis中的hash操作" class="headerlink" title="3.5 redis中的hash操作"></a>3.5 redis中的hash操作</h3><p>Redis hash 是一个键值对集合。Redis hash是一个string类型的field和value的映射表，hash特别适合用于存储对象。类似Java里面的Map<String,Object></p>
<p>需求：在redis里面保存一个用户对象( {id:1001,username:”eric”,age=23} )。</p>
<p><strong>方案1：</strong></p>
<p>将user对象转换成一个json字符串，使用string来存储这个json字符串。</p>
<p>缺点：每次修改这个对象里面的数据，都需要把这个字符串转换成java对象修改，修改之后再转换成json字符串，比较麻烦，不适合频繁修改数据的场景。</p>
<p><strong>方案2：</strong></p>
<p>通过key和对象属性拼接的方式存储数据:</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs txt">  key           value<br>user:id          1001<br>user:username    eric<br>user:age         23<br></code></pre></td></tr></table></figure>
<p>缺点：存储的数据分散，如果对象的属性过多，在redis中的key也会非常的多。</p>
<p><strong>方案3：</strong></p>
<p>通过redis中的hash类型的数据保存</p>
<p><img src="20221003145035.png" srcset="/img/loading.gif" lazyload></p>
<p>优点：<strong>通过 key(用户ID) + field(属性标签) 就可以操作对应属性数据了，既不需要重复存储数据，也不会带来序列化和并发修改控制的问题。</strong></p>
<h4 id="3-5-1-hash的常用命令"><a href="#3-5-1-hash的常用命令" class="headerlink" title="3.5.1 hash的常用命令"></a>3.5.1 hash的常用命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; hset user id 1001  # 向hash中存储数据 key是user field是id 值是1001<br>(integer) 1<br>127.0.0.1:6379&gt; hget user id # 获取指定的数据<br>&quot;1001&quot;<br>127.0.0.1:6379&gt; hmset user username eric age 23 # 批量向hash集合中添加数据<br>OK<br>127.0.0.1:6379&gt; hmget user username age  # 批量向hash集合中获取数据<br>1) &quot;eric&quot;<br>2) &quot;23&quot;<br>127.0.0.1:6379&gt; hexists user username  # 判断key中是否存在指定的field 存在返回1  不存在返回0<br>(integer) 1<br>127.0.0.1:6379&gt; hkeys user  # 获取所有的field<br>1) &quot;id&quot;<br>2) &quot;username&quot;<br>3) &quot;age&quot;<br>127.0.0.1:6379&gt; hvals user  # 获取所有的value值<br>1) &quot;1001&quot;<br>2) &quot;eric&quot;<br>3) &quot;23&quot;<br>127.0.0.1:6379&gt; hdel user age  # 删除指定的field及其对应的值<br>(integer) 1<br>127.0.0.1:6379&gt; hget user age<br>(nil)<br>127.0.0.1:6379&gt; hincrby user id 1  # 对指定的field的值进行自增/自减操作  1 自增  -1 递减<br>(integer) 1002<br>127.0.0.1:6379&gt; hincrby user id -1<br>(integer) 1001<br>127.0.0.1:6379&gt; hsetnx user age 25  # 给对应的field设置值 如果field存在设置不成功，如果field不存在，则设置成功。<br>(integer) 1<br>127.0.0.1:6379&gt; hsetnx user username james<br>(integer) 0<br>127.0.0.1:6379&gt; hget user age<br>&quot;25&quot;<br>127.0.0.1:6379&gt; hget user username<br>&quot;eric&quot;<br></code></pre></td></tr></table></figure>
<h4 id="3-5-2-hash的数据结构"><a href="#3-5-2-hash的数据结构" class="headerlink" title="3.5.2 hash的数据结构"></a>3.5.2 hash的数据结构</h4><p>Hash类型对应的数据结构是两种：ziplist（压缩列表），hashtable（哈希表）。当field-value长度较短且个数较少时，使用ziplist，否则使用hashtable。</p>
<h3 id="3-6-redis中-的zset操作"><a href="#3-6-redis中-的zset操作" class="headerlink" title="3.6 redis中 的zset操作"></a>3.6 redis中 的zset操作</h3><p>Redis有序集合zset与普通集合set非常相似，是一个没有重复元素的字符串集合。不同之处是有序集合的每个成员都关联了一个评分（score）,这个评分（score）被用来按照从最低分到最高分的方式排序集合中的成员。<strong>集合的成员是唯一的，但是评分可以是重复了。</strong></p>
<p>因为元素是有序的, 所以你也可以很快的根据评分（score）或者次序（position）来获取一个范围的元素。访问有序集合的中间元素也是非常快的,因此你能够使用有序集合作为一个没有重复成员的智能列表。</p>
<h4 id="3-6-1-zset的常用命令"><a href="#3-6-1-zset的常用命令" class="headerlink" title="3.6.1 zset的常用命令"></a>3.6.1 zset的常用命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; zadd user 99 kobe 88 durant 82 curry  # 添加元素到zset集合中<br>(integer) 3<br>127.0.0.1:6379&gt; zrange user 0 -1 # 显示zset集合中的所有值(按照分数的升序排序)<br>1) &quot;curry&quot;<br>2) &quot;durant&quot;<br>3) &quot;kobe&quot;<br>127.0.0.1:6379&gt; zrange user 0 -1 withscores   # 显示zset集合中的所有值 包括元素对应的分数<br>1) &quot;curry&quot;<br>2) &quot;82&quot;<br>3) &quot;durant&quot;<br>4) &quot;88&quot;<br>5) &quot;kobe&quot;<br>6) &quot;99&quot;<br>127.0.0.1:6379&gt; zrangebyscore user 80 89  # 取指定区间的元素<br>1) &quot;curry&quot;<br>2) &quot;durant&quot;<br>127.0.0.1:6379&gt; zrangebyscore user 80 89 withscores   # 取指定区间的元素 包括元素对应的分数<br>1) &quot;curry&quot;<br>2) &quot;82&quot;<br>3) &quot;durant&quot;<br>4) &quot;88&quot;<br>127.0.0.1:6379&gt; zrevrangebyscore user 100 1 # 显示zset集合中的所有值(按照分数的降序排序)<br>1) &quot;kobe&quot;<br>2) &quot;durant&quot;<br>3) &quot;curry&quot;<br>127.0.0.1:6379&gt; zincrby user 12 kobe  # 给指定的元素增加分数<br>&quot;111&quot;<br>127.0.0.1:6379&gt; zrange user 0 -1 withscores<br>1) &quot;curry&quot;<br>2) &quot;82&quot;<br>3) &quot;durant&quot;<br>4) &quot;88&quot;<br>5) &quot;kobe&quot;<br>6) &quot;111&quot;<br>127.0.0.1:6379&gt; zrem user kobe  # 删除指定的元素<br>(integer) 1<br>127.0.0.1:6379&gt; zrange user 0 -1<br>1) &quot;curry&quot;<br>2) &quot;durant&quot;<br>127.0.0.1:6379&gt; zcount user 0 100  # 统计指定分数区间的元素个数<br>(integer) 2<br>127.0.0.1:6379&gt; zrange user 0 -1<br>1) &quot;curry&quot;<br>2) &quot;durant&quot;<br>127.0.0.1:6379&gt; zrank user durant  # 查询指定元素的排名<br>(integer) 1<br>127.0.0.1:6379&gt; zrank user curry<br>(integer) 0<br></code></pre></td></tr></table></figure>
<h4 id="3-6-2-zset的数据结构"><a href="#3-6-2-zset的数据结构" class="headerlink" title="3.6.2 zset的数据结构"></a>3.6.2 zset的数据结构</h4><p>zset底层使用了两个数据结构：</p>
<p>（1）hash，hash的作用就是关联元素value和权重score，保障元素value的唯一性，可以通过元素value找到相应的score值。</p>
<p>（2）跳跃表，跳跃表的目的在于给元素value排序，根据score的范围获取元素列表。</p>
<p>什么是跳跃表?</p>
<p>有序集合在生活中比较常见，例如根据成绩对学生排名，根据得分对玩家排名等。对于有序集合的底层实现，可以用数组、平衡树、链表等。数组不便元素的插入、删除；平衡树或红黑树虽然效率高但结构复杂；链表查询需要遍历所有效率低。Redis采用的是跳跃表。跳跃表效率堪比红黑树，实现远比红黑树简单。</p>
<p>实例：</p>
<p>对比有序链表和跳跃表，从链表中查询出51。</p>
<ul>
<li>有序链表</li>
</ul>
<p><img src="20221003155230.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<p>要查找值为51的元素，需要从第一个元素开始依次查找、比较才能找到。共需要6次比较。</p>
<ul>
<li>跳跃表</li>
</ul>
<p><img src="20221003155318.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<p>从第2层开始，1节点比51节点小，向后比较。</p>
<p>21节点比51节点小，继续向后比较，后面就是NULL了，所以从21节点向下到第1层</p>
<p>在第1层，41节点比51节点小，继续向后，61节点比51节点大，所以从41向下</p>
<p>在第0层，51节点为要查找的节点，节点被找到，共查找4次。</p>
<p><strong>从此可以看出跳跃表比有序链表效率要高。</strong></p>
<h2 id="4-redis配置文件的介绍"><a href="#4-redis配置文件的介绍" class="headerlink" title="4 redis配置文件的介绍"></a>4 redis配置文件的介绍</h2><h3 id="4-1-数据单位配置"><a href="#4-1-数据单位配置" class="headerlink" title="4.1 数据单位配置"></a>4.1 数据单位配置</h3><p>配置大小单位,开头定义了一些基本的度量单位，只支持bytes。</p>
<p><img src="20221003163833.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<h3 id="4-2-INCLUDES配置"><a href="#4-2-INCLUDES配置" class="headerlink" title="4.2 INCLUDES配置"></a>4.2 INCLUDES配置</h3><p><img src="20221003164002.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<p>我们可以把一些配置信息定义在子配置文件里面，再在redis.conf中引入进来。</p>
<h3 id="4-3-网络相关的配置"><a href="#4-3-网络相关的配置" class="headerlink" title="4.3 网络相关的配置"></a>4.3 网络相关的配置</h3><h4 id="4-3-1-bind"><a href="#4-3-1-bind" class="headerlink" title="4.3.1 bind"></a>4.3.1 bind</h4><p>默认情况bind=127.0.0.1只能接受本机的访问请求。不写的情况下，无限制接受任何ip地址的访问。</p>
<p>生产环境肯定要写你应用服务器的地址；服务器是需要远程访问的，所以需要将其注释掉。</p>
<p>如果开启了protected-mode，那么在没有设定bind ip且没有设密码的情况下，Redis只允许接受本机的响应。</p>
<p><img src="20221003164246.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<p>保存配置，停止服务，重启启动查看进程，不再是本机访问了。</p>
<p><img src="20221003164353.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<h4 id="4-3-2-protected-mode"><a href="#4-3-2-protected-mode" class="headerlink" title="4.3.2 protected-mode"></a>4.3.2 protected-mode</h4><p><img src="20221003164715.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<p>将本机访问保护模式设置no。这样其他机器就可以远程连接redis。</p>
<h4 id="4-3-3-port"><a href="#4-3-3-port" class="headerlink" title="4.3.3 port"></a>4.3.3 port</h4><p>redis的默认端口号：6379</p>
<p><img src="20221003164838.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<h4 id="4-3-4-tcp-backlog"><a href="#4-3-4-tcp-backlog" class="headerlink" title="4.3.4 tcp-backlog"></a>4.3.4 tcp-backlog</h4><p><img src="20221003164937.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<p>设置tcp的backlog，backlog其实是一个连接队列，backlog队列总和=未完成三次握手队列 + 已经完成三次握手队列。</p>
<p>在高并发环境下你需要一个高backlog值来避免慢客户端连接问题。</p>
<p>注意Linux内核会将这个值减小到/proc/sys/net/core/somaxconn的值（128），所以需要确认增大/proc/sys/net/core/somaxconn和/proc/sys/netipv4/tcp_max_syn_backlog（128）两个值来达到想要的效果。</p>
<h4 id="4-3-5-timeout"><a href="#4-3-5-timeout" class="headerlink" title="4.3.5 timeout"></a>4.3.5 timeout</h4><p>一个空闲的客户端维持多少秒会关闭，0表示关闭该功能。即永不关闭。</p>
<p><img src="20221003165202.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<h4 id="4-3-6-tcp-keepalive"><a href="#4-3-6-tcp-keepalive" class="headerlink" title="4.3.6 tcp-keepalive"></a>4.3.6 tcp-keepalive</h4><p>对访问客户端的一种心跳检测，每隔n秒检测一次。</p>
<p>单位为秒，如果设置为0，则不会进行Keepalive检测，默认值为300。</p>
<p><img src="20221003165420.png" srcset="/img/loading.gif" lazyload style="zoom:90%"> </p>
<h3 id="4-4-GENERAL通用配置"><a href="#4-4-GENERAL通用配置" class="headerlink" title="4.4 GENERAL通用配置"></a>4.4 GENERAL通用配置</h3><h4 id="4-4-1-daemonize"><a href="#4-4-1-daemonize" class="headerlink" title="4.4.1 daemonize"></a>4.4.1 daemonize</h4><p>是否为后台进程，设置为yes，守护进程，后台启动。</p>
<p><img src="20221003165628.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<h4 id="4-4-2-pidfile"><a href="#4-4-2-pidfile" class="headerlink" title="4.4.2 pidfile"></a>4.4.2 pidfile</h4><p><img src="20221003165720.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<p>存放pid文件的位置，每个实例会产生一个不同的pid文件。</p>
<h4 id="4-4-3-loglevel"><a href="#4-4-3-loglevel" class="headerlink" title="4.4.3 loglevel"></a>4.4.3 loglevel</h4><p>指定日志记录级别，Redis总共支持四个级别：debug、verbose、notice、warning，默认为<strong>notice</strong></p>
<p><img src="20221003165924.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<h4 id="4-4-4-logfile"><a href="#4-4-4-logfile" class="headerlink" title="4.4.4 logfile"></a>4.4.4 logfile</h4><p>日志文件的名称。</p>
<p><img src="20221003170120.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<h4 id="4-4-5-databases"><a href="#4-4-5-databases" class="headerlink" title="4.4.5 databases"></a>4.4.5 databases</h4><p>设定库的数量 默认16，默认数据库为0，可以使用<code>SELECT &lt;dbid&gt;</code>命令在连接上指定数据库id。</p>
<p><img src="20221003170244.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<h3 id="4-5-SECURITY安全配置"><a href="#4-5-SECURITY安全配置" class="headerlink" title="4.5 SECURITY安全配置"></a>4.5 SECURITY安全配置</h3><h4 id="4-5-1-设置密码"><a href="#4-5-1-设置密码" class="headerlink" title="4.5.1 设置密码"></a>4.5.1 设置密码</h4><p><img src="20221003175948.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<p>如果想要设置密码访问redis，需要进行如下配置:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; config get requirepass<br>1)&quot;requirepass&quot;<br>2)&quot;&quot;  # 密码默认为空<br>127.0.0.1:6379&gt; config set requirepass 123456<br>OK<br>127.0.0.1:6379&gt; auth 123456  # 一旦设置密码，所有的redis操作都要先验证密码<br>OK<br>127.0.0.1:6379&gt; get k1<br>&quot;v1&quot;<br></code></pre></td></tr></table></figure>
<h3 id="4-6-LIMITS配置"><a href="#4-6-LIMITS配置" class="headerlink" title="4.6 LIMITS配置"></a>4.6 LIMITS配置</h3><h4 id="4-6-1-maxclients"><a href="#4-6-1-maxclients" class="headerlink" title="4.6.1 maxclients"></a>4.6.1 maxclients</h4><p>maxclients：设置redis同时可以与多少个客户端进行连接。 默认情况下为10000个客户端。如果达到了此限制，redis则会拒绝新的连接请求，并且向这些连接请求方发出“max number of clients reached”以作回应。</p>
<p><img src="20221003171305.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<h4 id="4-6-2-maxmemory"><a href="#4-6-2-maxmemory" class="headerlink" title="4.6.2 maxmemory"></a>4.6.2 maxmemory</h4><p>建议<strong>必须设置</strong>，否则，将内存占满，造成服务器宕机。</p>
<p>设置redis可以使用的内存量。一旦到达内存使用上限，redis将会试图移除内部数据，移除规则可以通过maxmemory-policy来指定。</p>
<p>如果redis无法根据移除规则来移除内存中的数据，或者设置了“不允许移除”，那么redis则会针对那些需要申请内存的指令返回错误信息，比如SET、LPUSH等。</p>
<p>但是对于无内存申请的指令，仍然会正常响应，比如GET等。如果你的redis是主redis（说明你的redis有从redis），那么在设置内存使用上限时，需要在系统中留出一些内存空间给同步队列缓存，只有在你设置的是“不移除”的情况下，才不用考虑这个因素。</p>
<p><img src="20221003171658.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<h4 id="4-6-3-maxmemory-policy"><a href="#4-6-3-maxmemory-policy" class="headerlink" title="4.6.3 maxmemory-policy"></a>4.6.3 maxmemory-policy</h4><ul>
<li>volatile-lru：使用LRU算法移除key，只对设置了过期时间的键；（最近最少使用）</li>
<li>allkeys-lru：在所有集合key中，使用LRU算法移除key</li>
<li>volatile-random：在过期集合中移除随机的key，只对设置了过期时间的键</li>
<li>allkeys-random：在所有集合key中，移除随机的key</li>
<li>volatile-ttl：移除那些TTL值最小的key，即那些最近要过期的key</li>
<li>noeviction：不进行移除。针对写操作，只是返回错误信息</li>
</ul>
<p><img src="20221003171842.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<h2 id="5-redis的发布和订阅"><a href="#5-redis的发布和订阅" class="headerlink" title="5 redis的发布和订阅"></a>5 redis的发布和订阅</h2><ul>
<li>打开一个客户端1订阅channel1</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">[qgc@qgc-virtual-machine]~$ </span><span class="language-bash">redis-cli</span><br>127.0.0.1:6379&gt; subscribe channel1<br>Reading messages... (press Ctrl-C to quit)<br>1) &quot;subscribe&quot;<br>2) &quot;channel1&quot;<br>3) (integer) 1<br></code></pre></td></tr></table></figure>
<ul>
<li>打开客户端2，发送消息hello</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">[qgc@qgc-virtual-machine]~$ </span><span class="language-bash">redis-cli</span><br>127.0.0.1:6379&gt; publish channel1 hello<br>(integer) 1<br></code></pre></td></tr></table></figure>
<ul>
<li>再次查看客户端1</li>
</ul>
<p><img src="image-20230902112849915.png" srcset="/img/loading.gif" lazyload alt="image-20230902112849915"></p>
<h2 id="6-redis的新的数据类型"><a href="#6-redis的新的数据类型" class="headerlink" title="6 redis的新的数据类型"></a>6 redis的新的数据类型</h2><h3 id="6-1-Bitmap-位图"><a href="#6-1-Bitmap-位图" class="headerlink" title="6.1 Bitmap(位图)"></a>6.1 Bitmap(位图)</h3><p>现在我们来看一个场景，就是各大app都有签到的功能，大家可以思考，用户签到的功能是如何实现的。首先想到的就是设计一张签到表，将用户的签到信息持久化的保存在数据表里面。我们可以设计这么一张表：</p>
<p><img src="20221004134919.png" srcset="/img/loading.gif" lazyload style="zoom:60%"></p>
<p>用户一次签到，就是一条记录,然后将记录持久化的保存在数据表里面。大家设想一下这么个场景：假如有1000万用户，平均每人每年签到次数为10次，则这张表一年的数据量为 1亿条。每签到一次需要使用（8 + 8 + 1 + 1 + 3 + 1）共22 字节的内存，一个月则最多需要600多字节。可以想象到1000万用户一年的数据量需要的内存空间该有多大。</p>
<p>我们如何能够简化一点呢？其实可以考虑小时候一个挺常见的方案，就是小时候，咱们准备一张小小的卡片，你只要签到就打上一个勾，我最后判断你是否签到，其实只需要到小卡片上看一看就知道了</p>
<p>我们可以采用类似这样的方案来实现我们的签到需求。</p>
<p>我们按月来统计用户签到信息，签到记录为1，未签到则记录为0.</p>
<p>把每一个bit位对应当月的每一天，形成了映射关系。用0和1标示业务状态，这种思路就称为位图（BitMap）。这样我们就用极小的空间，来实现了大量数据的表示</p>
<p>Redis中是利用string类型数据结构实现BitMap，因此最大上限是512M，转换为bit则是 2^32个bit位。</p>
<p><img src="20221004141847.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<p>BitMap的操作命令有：</p>
<ul>
<li>SETBIT：向指定位置（offset）存入一个0或1</li>
<li>GETBIT ：获取指定位置（offset）的bit值</li>
<li>BITCOUNT ：统计BitMap中值为1的bit位的数量</li>
<li>BITFIELD ：操作（查询、修改、自增）BitMap中bit数组中的指定位置（offset）的值</li>
<li>BITFIELD_RO ：获取BitMap中bit数组，并以十进制形式返回</li>
<li>BITOP ：将多个BitMap的结果做位运算（与 、或、异或）</li>
<li>BITPOS ：查找bit数组中指定范围内第一个0或1出现的位置</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; setbit bit1 0 1  # 向指定的位置存入值<br>(integer) 0<br>127.0.0.1:6379&gt; setbit bit1 1 1<br>(integer) 0<br>127.0.0.1:6379&gt; setbit bit1 2 1<br>(integer) 0<br>127.0.0.1:6379&gt; setbit bit1 4 1<br>(integer) 0<br>127.0.0.1:6379&gt; setbit bit1 6 1<br>(integer) 0<br>127.0.0.1:6379&gt; setbit bit1 7 1<br>(integer) 0<br></code></pre></td></tr></table></figure>
<p>最后得到的结果是:</p>
<p><img src="20221004144534.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; getbit bit1 1 # 从指定位置获取值<br>(integer) 1<br>127.0.0.1:6379&gt; getbit bit1 3<br>(integer) 0<br>127.0.0.1:6379&gt; bitcount bit1  # 统计1出现的次数(可以统计签到次数)<br>(integer) 6<br>127.0.0.1:6379&gt; bitfield bit1 get u2 0 #从0号索引开始获取2个bit位 再转换成10进制数据<br>1) (integer) 3<br>127.0.0.1:6379&gt; bitfield bit1 get u3 0<br>1) (integer) 7<br>127.0.0.1:6379&gt; bitpos bit1 0  # 统计第一个0出现的位置<br>(integer) 3<br>127.0.0.1:6379&gt; setbit unique:users:20201104 1 1  # 2020-11-04 日访问网站的userid=1,2,5,9。<br>(integer) 0<br>127.0.0.1:6379&gt; setbit unique:users:20201104 2 1<br>(integer) 0<br>127.0.0.1:6379&gt; setbit unique:users:20201104 5 1<br>(integer) 0<br>127.0.0.1:6379&gt; setbit unique:users:20201104 9 1<br>(integer) 0<br>127.0.0.1:6379&gt; setbit unique:users:20201103 0 1 # 2020-11-03 日访问网站的userid=0,1,4,9。<br>(integer) 0<br>127.0.0.1:6379&gt; setbit unique:users:20201103 1 1<br>(integer) 0<br>127.0.0.1:6379&gt; setbit unique:users:20201103 4 1<br>(integer) 0<br>127.0.0.1:6379&gt; setbit unique:users:20201103 9 1<br>(integer) 0<br>127.0.0.1:6379&gt; bitop and unique:users:20201104 unique:users:20201103 # 统计两天都访问网站的人数<br>(integer) 2<br></code></pre></td></tr></table></figure>
<h3 id="6-2-HyperLogLog"><a href="#6-2-HyperLogLog" class="headerlink" title="6.2 HyperLogLog"></a>6.2 HyperLogLog</h3><h4 id="6-2-1-HyperLogLog简介"><a href="#6-2-1-HyperLogLog简介" class="headerlink" title="6.2.1 HyperLogLog简介"></a>6.2.1 HyperLogLog简介</h4><p>在工作当中，我们经常会遇到与统计相关的功能需求，比如统计网站PV（PageView页面访问量）,可以使用Redis的incr、incrby轻松实现。</p>
<p>但像UV（UniqueVisitor，独立访客）、独立IP数、搜索记录数等需要去重和计数的问题如何解决？<strong>这种求集合中不重复元素个数的问题称为基数问题。</strong></p>
<p>解决基数问题有很多种方案：</p>
<p>（1）数据存储在MySQL表中，使用distinct count计算不重复个数</p>
<p>（2）使用Redis提供的hash、set、bitmaps等数据结构来处理</p>
<p>以上的方案结果精确，但随着数据不断增加，导致占用空间越来越大，对于非常大的数据集是不切实际的。</p>
<p>能否能够降低一定的精度来平衡存储空间？Redis推出了HyperLogLog</p>
<p>Redis HyperLogLog 是用来做基数统计的算法，HyperLogLog 的优点是，在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定的、并且是很小的。</p>
<p>在 Redis 里面，每个 HyperLogLog 键只需要花费 12 KB 内存，就可以计算接近 2^64 个不同元素的基数。这和计算基数时，元素越多耗费内存就越多的集合形成鲜明对比。</p>
<p>但是，因为 HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。</p>
<p>什么是基数?</p>
<p>比如数据集 {1, 3, 5, 7, 5, 7, 8}， 那么这个数据集的基数集为 {1, 3, 5 ,7, 8}, 基数(不重复元素)为5。 基数估计就是在误差可接受的范围内，快速计算基数。</p>
<h4 id="6-2-2-命令操作"><a href="#6-2-2-命令操作" class="headerlink" title="6.2.2 命令操作"></a>6.2.2 命令操作</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; pfadd subject java  # 添加元素<br>(integer) 1<br>127.0.0.1:6379&gt; pfadd subject php<br>(integer) 1<br>127.0.0.1:6379&gt; pfadd subject java<br>(integer) 0<br>127.0.0.1:6379&gt; pfadd subject mysql<br>(integer) 1<br>127.0.0.1:6379&gt; pfadd subject html spring <br>(integer) 1<br>127.0.0.1:6379&gt; pfcount subject  # 统计元素的个数<br>(integer) 5<br>127.0.0.1:6379&gt; pfadd program oracle springboot<br>(integer) 1<br>127.0.0.1:6379&gt; pfcount program<br>(integer) 2<br>127.0.0.1:6379&gt; pfmerge k1 subject program  # 将两个key所属的元素合并到k1里面去。<br>OK<br>127.0.0.1:6379&gt; pfcount k1<br>(integer) 7<br></code></pre></td></tr></table></figure>
<h3 id="6-3-Geospatial"><a href="#6-3-Geospatial" class="headerlink" title="6.3 Geospatial"></a>6.3 Geospatial</h3><h4 id="6-3-1-Geospatial简介"><a href="#6-3-1-Geospatial简介" class="headerlink" title="6.3.1 Geospatial简介"></a>6.3.1 Geospatial简介</h4><p>Redis 3.2 中增加了对GEO类型的支持。GEO，Geographic，地理信息的缩写。该类型，就是元素的2维坐标，在地图上就是经纬度。redis基于该类型，提供了经纬度设置，查询，范围查询，距离查询，经纬度Hash等常见操作。</p>
<h4 id="6-3-2-命令操作"><a href="#6-3-2-命令操作" class="headerlink" title="6.3.2 命令操作"></a>6.3.2 命令操作</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; geoadd china:city 121.47 31.23 shanghai #存数据<br>(integer) 1<br>127.0.0.1:6379&gt; geoadd china:city 106.50 29.53 chongqing 114.05 22.52 shenzhen 116.38 39.90 beijing # 也可以批量存储数据<br>(integer) 3<br>127.0.0.1:6379&gt; geopos china:city shanghai  # 获取指定城市的经纬度<br>1) 1) &quot;121.47000163793563843&quot;<br>   2) &quot;31.22999903975783553&quot;<br>127.0.0.1:6379&gt; geopos china:city  beijing<br>1) 1) &quot;116.38000041246414185&quot;<br>   2) &quot;39.90000009167092543&quot;<br>127.0.0.1:6379&gt; geodist china:city beijing shanghai  # 显示北京到上海之间的直线距离(米)<br>&quot;1068153.5181&quot;<br>127.0.0.1:6379&gt; geodist china:city beijing shanghai km   # 显示北京到上海之间的直线距离(千米)<br>&quot;1068.1535&quot;<br>127.0.0.1:6379&gt; georadius china:city 110 30 1000 km  # 找出东经110度 北纬30度 1000公里半径内的城市<br>1) &quot;chongqing&quot;<br>2) &quot;shenzhen&quot;<br></code></pre></td></tr></table></figure>
<p><strong>注意：两极(南极 北极)无法直接添加，一般会下载城市数据，直接通过 Java 程序一次性导入。有效的经度从 -180 度到 180 度。有效的纬度从 -85.05112878 度到 85.05112878 度。当坐标位置超出指定范围时，该命令将会返回一个错误。已经添加的数据，是无法再次往里面添加的。</strong></p>
<h2 id="7-redis的事务操作"><a href="#7-redis的事务操作" class="headerlink" title="7 redis的事务操作"></a>7 redis的事务操作</h2><p>Redis事务是一个单独的隔离操作：事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。Redis事务的主要作用就是串联多个命令防止别的命令插队。</p>
<h3 id="7-1-事务的基本操作"><a href="#7-1-事务的基本操作" class="headerlink" title="7.1 事务的基本操作"></a>7.1 事务的基本操作</h3><h4 id="7-1-1-redis事务命令的使用"><a href="#7-1-1-redis事务命令的使用" class="headerlink" title="7.1.1 redis事务命令的使用"></a>7.1.1 redis事务命令的使用</h4><ul>
<li><p>multi   从输入Multi命令开始，输入的命令都会依次进入命令队列中，但不会执行。</p>
</li>
<li><p>exec   输入exec后，Redis会将之前的命令队列中的命令依次执行。</p>
</li>
<li><p>discard  放弃将队列中的命令执行</p>
</li>
</ul>
<p><img src="20221004171957.png" srcset="/img/loading.gif" lazyload style="zoom:60%"></p>
<p>使用案例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; multi  # 开启事务<br>OK<br>127.0.0.1:6379(TX)&gt; set k1 v1 # 命令1<br>QUEUED<br>127.0.0.1:6379(TX)&gt; set k2 v2 # 命令2<br>QUEUED<br>127.0.0.1:6379(TX)&gt; get k1  # 命令3<br>QUEUED<br>127.0.0.1:6379(TX)&gt; get k2  # 命令4<br>QUEUED<br>127.0.0.1:6379(TX)&gt; exec  # 提交事务 事务中的所有命令都会执行<br>1) OK<br>2) OK<br>3) &quot;v1&quot;<br>4) &quot;v2&quot;<br></code></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; flushdb<br>OK<br>127.0.0.1:6379&gt; multi<br>OK<br>127.0.0.1:6379(TX)&gt; set k1 v1<br>QUEUED<br>127.0.0.1:6379(TX)&gt; set k2 v2<br>QUEUED<br>127.0.0.1:6379(TX)&gt; get k1<br>QUEUED<br>127.0.0.1:6379(TX)&gt; get k2<br>QUEUED<br>127.0.0.1:6379(TX)&gt; discard # 打断事务，事务中的所有命令都不会执行<br>OK<br>127.0.0.1:6379&gt; get k1<br>(nil)<br>127.0.0.1:6379&gt; get k2<br>(nil)<br></code></pre></td></tr></table></figure>
<h4 id="7-1-2-事务的错误处理"><a href="#7-1-2-事务的错误处理" class="headerlink" title="7.1.2 事务的错误处理"></a>7.1.2 事务的错误处理</h4><ul>
<li>组队中某个命令出现了报告错误(组队时出现错误)，执行时整个的所有队列都会被取消。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; multi <br>OK<br>127.0.0.1:6379(TX)&gt; set k1 v1<br>QUEUED<br>127.0.0.1:6379(TX)&gt; set k2  # 由于命令出了语法问题，所以在入列的时候就会报错<br>(error) ERR wrong number of arguments for &#x27;set&#x27; command<br>127.0.0.1:6379(TX)&gt; get k1<br>QUEUED<br>127.0.0.1:6379(TX)&gt; get k2<br>QUEUED<br>127.0.0.1:6379(TX)&gt; exec  # 由于组队的时候就出现了错误，所以所有的redis指令都不会执行<br>(error) EXECABORT Transaction discarded because of previous errors.<br>127.0.0.1:6379&gt; get k1<br>(nil)<br>127.0.0.1:6379&gt; get k2<br>(nil)<br></code></pre></td></tr></table></figure>
<ul>
<li>组队中(入列时)命令没有问题，在执行的时候出了问题，则只有报错的命令不会被执行，而其他的命令都会执行，不会回滚。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; multi<br>OK<br>127.0.0.1:6379(TX)&gt; set k1 v1<br>QUEUED<br>127.0.0.1:6379(TX)&gt; incr k1  # 语法没有问题，在执行的时候会出问题，因为只有数字才能自增<br>QUEUED<br>127.0.0.1:6379(TX)&gt; set k2 v2<br>QUEUED<br>127.0.0.1:6379(TX)&gt; get k1<br>QUEUED<br>127.0.0.1:6379(TX)&gt; exec<br>1) OK<br>2) (error) ERR value is not an integer or out of range<br>3) OK<br>4) &quot;v1&quot;<br></code></pre></td></tr></table></figure>
<h3 id="7-2-事务的冲突"><a href="#7-2-事务的冲突" class="headerlink" title="7.2 事务的冲突"></a>7.2 事务的冲突</h3><h4 id="7-2-1-事务冲突出现的场景"><a href="#7-2-1-事务冲突出现的场景" class="headerlink" title="7.2.1 事务冲突出现的场景"></a>7.2.1 事务冲突出现的场景</h4><p>想想一个场景：有很多人有你的账户,同时去参加双十一抢购</p>
<p>假设你有一个账户，此时你有三个女友(A  B  C)都知道你账户，现在她们拿着你的银行账户同时进行消费。</p>
<p>一个请求想给金额减8000；一个请求想给金额减5000；一个请求想给金额减1000</p>
<p><img src="20221004180704.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<h4 id="7-2-2-解决事务的冲突问题"><a href="#7-2-2-解决事务的冲突问题" class="headerlink" title="7.2.2 解决事务的冲突问题"></a>7.2.2 解决事务的冲突问题</h4><ul>
<li>悲观锁</li>
</ul>
<p><img src="20221004180829.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<p><strong>悲观锁(Pessimistic Lock)</strong>, 顾名思义，就是很悲观，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会block直到它拿到锁。<strong>传统的关系型数据库里边就用到了很多这种锁机制</strong>，比如<strong>行锁</strong>，<strong>表锁</strong>等，<strong>读锁</strong>，<strong>写锁</strong>等，都是在做操作之前先上锁。</p>
<ul>
<li>乐观锁</li>
</ul>
<p><img src="20221004181028.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<p><strong>乐观锁(Optimistic Lock),</strong> 顾名思义，就是很乐观，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，可以使用版本号等机制。<strong>乐观锁适用于多读的应用类型，这样可以提高吞吐量</strong>。Redis就是利用这种check-and-set机制实现事务的。</p>
<h4 id="7-2-3-使用watch命令实现redis乐观锁"><a href="#7-2-3-使用watch命令实现redis乐观锁" class="headerlink" title="7.2.3 使用watch命令实现redis乐观锁"></a>7.2.3 使用watch命令实现redis乐观锁</h4><p>在执行multi之前，先执行watch key1 [key2],可以监视一个(或多个) key ，如果在事务<strong>执行之前这个(或这些) key 被其他命令所改动，那么事务将被打断。</strong></p>
<p>现在我们使用两个客户端来演示redis的乐观锁</p>
<ul>
<li>在客户端1 设置一个balance，然后watch这个key</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; set balance 100  # 设置账户余额信息 100<br>OK<br>127.0.0.1:6379&gt; watch balance  # 使用watch指令监控这个key值<br>OK<br></code></pre></td></tr></table></figure>
<ul>
<li>在客户端2 也watch这个key</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; watch balance  # 使用watch指令监控这个key值<br>OK<br></code></pre></td></tr></table></figure>
<ul>
<li>在客户端1开启事务，并修改账户余额信息，但是不提交事务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; multi<br>OK<br>127.0.0.1:6379(TX)&gt; decrby balance 20<br>QUEUED<br></code></pre></td></tr></table></figure>
<ul>
<li>在客户端2开启事务，并修改账户余额信息，但是不提交事务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; multi<br>OK<br>127.0.0.1:6379(TX)&gt; decrby balance 30<br>QUEUED<br></code></pre></td></tr></table></figure>
<ul>
<li>客户端1提交事务,查看效果</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379(TX)&gt; exec<br>1) (integer) 80<br>127.0.0.1:6379&gt; get balance<br>&quot;80&quot;<br></code></pre></td></tr></table></figure>
<ul>
<li>客户端2提交事务,查看效果</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379(TX)&gt; exec  # 事务中的命令没有被执行，因为客户端2监控的key值发生了变化<br>(nil)<br>127.0.0.1:6379&gt; get balance<br>&quot;80&quot;<br></code></pre></td></tr></table></figure>
<h4 id="7-2-4-redis事务的特性"><a href="#7-2-4-redis事务的特性" class="headerlink" title="7.2.4 redis事务的特性"></a>7.2.4 redis事务的特性</h4><ul>
<li><p>单独的隔离操作 </p>
<ul>
<li>事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。 </li>
</ul>
</li>
<li><p>没有隔离级别的概念 </p>
<ul>
<li>队列中的命令没有提交之前都不会实际被执行，因为事务提交前任何指令都不会被实际执行。</li>
</ul>
</li>
<li><p>不保证原子性 </p>
<ul>
<li>事务中如果有一条命令执行失败，其后的命令仍然会被执行，没有回滚 。</li>
</ul>
</li>
</ul>
<h2 id="8-redis持久化操作"><a href="#8-redis持久化操作" class="headerlink" title="8 redis持久化操作"></a>8 redis持久化操作</h2><p><img src="20221004211921.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<p>Redis 提供了2个不同形式的持久化方式。</p>
<ul>
<li>RDB（Redis DataBase）</li>
<li>AOF（Append Of File）</li>
</ul>
<h3 id="8-1-RDB持久化"><a href="#8-1-RDB持久化" class="headerlink" title="8.1 RDB持久化"></a>8.1 RDB持久化</h3><h4 id="8-1-1-什么是RDB持久化"><a href="#8-1-1-什么是RDB持久化" class="headerlink" title="8.1.1 什么是RDB持久化"></a>8.1.1 什么是RDB持久化</h4><p>在指定的时间间隔内将内存中的数据集快照写入磁盘， 也就是行话讲的Snapshot快照，它恢复时是将快照文件直接读到内存里。</p>
<h4 id="8-1-2-RDB持久化流程"><a href="#8-1-2-RDB持久化流程" class="headerlink" title="8.1.2 RDB持久化流程"></a>8.1.2 RDB持久化流程</h4><p>Redis会单独创建（fork）一个子进程来进行持久化，会先将数据写入到 一个临时文件中，待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件。 整个过程中，主进程是不进行任何IO操作的，这就确保了极高的性能 如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那RDB方式要比AOF方式更加的高效。<strong>RDB的缺点是最后一次持久化后的数据可能丢失。</strong></p>
<p><img src="20221004215739.png" srcset="/img/loading.gif" lazyload style="zoom:60%"></p>
<h4 id="8-1-3-RDB持久化触发策略"><a href="#8-1-3-RDB持久化触发策略" class="headerlink" title="8.1.3 RDB持久化触发策略"></a>8.1.3 RDB持久化触发策略</h4><p>RDB 持久化提供了两种触发策略：一种是手动触发，另一种是自动触发。</p>
<ul>
<li>手动触发策略</li>
</ul>
<p>手动触发是通过<code>SAVE</code>命令或者<code>BGSAVE</code>命令将内存数据保存到磁盘文件+中。如下所示：</p>
<p>save：会阻塞当前Redis服务器，直到持久化完成，<strong>线上应该禁止使用</strong>。</p>
<p>bgsave：该触发方式会fork一个子进程，由子进程负责持久化过程，因此阻塞只会发生在fork子进程的时候。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; SAVE<br>OK<br>127.0.0.1:6379&gt; BGSAVE<br>Background saving started<br>127.0.0.1:6379&gt;  LASTSAVE<br>(integer) 1611298430<br></code></pre></td></tr></table></figure>
<ul>
<li>自动触发</li>
</ul>
<p>自动触发策略，是指 Redis 在指定的时间内，数据发生了多少次变化时，会自动执行<code>BGSAVE</code>命令。自动触发的条件包含在了 Redis 的配置文件中，如下所示：</p>
<p><img src="20221004215333.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<p>上图所示， save m n 的含义是在时间 m 秒内，如果 Redis 数据至少发生了 n 次变化，那么就自动执行<code>BGSAVE</code>命令。配置策略说明如下：</p>
<p>上图所示， save m n 的含义是在时间 m 秒内，如果 Redis 数据至少发生了 n 次变化，那么就自动执行<code>BGSAVE</code>命令。配置策略说明如下：</p>
<p>① save 900 1 表示在 900 秒内，至少更新了 1 条数据，Redis 自动触发 BGSAVE 命令，将数据保存到硬盘。</p>
<p>② save 300 10 表示在 300 秒内，至少更新了 10 条数据，Redis 自动触 BGSAVE 命令，将数据保存到硬盘。</p>
<p>③ save 60 10000 表示 60 秒内，至少更新了 10000 条数据，Redis 自动触发 BGSAVE 命令，将数据保存到硬盘。只要上述三个条件任意满足一个，服务器就会自动执行<code>BGSAVE</code>命令。当然您可以根据实际情况自己调整触发策略。</p>
<h4 id="8-1-4-dump-rdb文件"><a href="#8-1-4-dump-rdb文件" class="headerlink" title="8.1.4 dump.rdb文件"></a>8.1.4 dump.rdb文件</h4><p>在redis.conf中配置文件名称，默认为dump.rdb。</p>
<p><img src="20221004220227.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<p>rdb文件的保存路径，也可以修改。默认为Redis启动时命令行所在的目录下,我们也可以自定义目录位置。</p>
<p><img src="20221004220351.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<h4 id="8-1-5-stop-writes-on-bgsave-error"><a href="#8-1-5-stop-writes-on-bgsave-error" class="headerlink" title="8.1.5 stop-writes-on-bgsave-error"></a>8.1.5 stop-writes-on-bgsave-error</h4><p>当Redis无法写入磁盘的话，直接关掉Redis的写操作。推荐yes。</p>
<p><img src="20221004220533.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<h4 id="8-1-6-RDB持久化特点"><a href="#8-1-6-RDB持久化特点" class="headerlink" title="8.1.6 RDB持久化特点"></a>8.1.6 RDB持久化特点</h4><ul>
<li><p>优势：</p>
<ul>
<li><p>适合大规模的数据恢复</p>
</li>
<li><p>对数据完整性和一致性要求不高更适合使用</p>
</li>
<li><p>节省磁盘空间</p>
</li>
<li><p>恢复速度快</p>
</li>
</ul>
</li>
<li><p>劣势</p>
<ul>
<li>Fork的时候，内存中的数据被克隆了一份，大致2倍的膨胀性需要考虑。</li>
<li>虽然Redis在fork时使用了<strong>写时拷贝技术</strong>,但是如果数据庞大时还是比较消耗性能。</li>
<li>l在备份周期在一定间隔时间做一次备份，所以如果Redis意外down掉的话，就会丢失最后一次快照后的所有修改。</li>
</ul>
</li>
</ul>
<h3 id="8-2-AOF持久化"><a href="#8-2-AOF持久化" class="headerlink" title="8.2 AOF持久化"></a>8.2 AOF持久化</h3><p>AOF：append only file</p>
<h4 id="8-2-1-什么是AOF持久化"><a href="#8-2-1-什么是AOF持久化" class="headerlink" title="8.2.1 什么是AOF持久化"></a>8.2.1 什么是AOF持久化</h4><p>以<strong>日志</strong>的形式来记录每个写操作（增量保存），将Redis执行过的所有写指令记录下来(<strong>读操作不记录</strong>)， <strong>只许追加文件但不可以改写文件</strong>，redis启动之初会读取该文件重新构建数据，换言之，redis 重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作。</p>
<p><strong>注意：AOF默认不开启。可以在redis.conf中配置文件名称，默认为 appendonly.aof。AOF文件的保存路径，同RDB的路径一致。</strong></p>
<p>AOF和RDB同时开启，系统默认取AOF的数据（数据不会存在丢失）。</p>
<h4 id="8-2-2-AOF持久化规则"><a href="#8-2-2-AOF持久化规则" class="headerlink" title="8.2.2 AOF持久化规则"></a>8.2.2 AOF持久化规则</h4><ul>
<li>appendfsync always</li>
</ul>
<p>始终同步，每次Redis的写入都会立刻记入日志；性能较差但数据完整性比较好</p>
<ul>
<li>appendfsync everysec</li>
</ul>
<p>每秒同步，每秒记入日志一次，如果宕机，本秒的数据可能丢失。</p>
<ul>
<li>appendfsync no</li>
</ul>
<p>redis不主动进行同步，把同步时机交给操作系统。</p>
<h4 id="8-2-3-ReWrite重写机制"><a href="#8-2-3-ReWrite重写机制" class="headerlink" title="8.2.3 ReWrite重写机制"></a>8.2.3 ReWrite重写机制</h4><p>AOF采用文件追加方式，文件会越来越大为避免出现此种情况，新增了重写机制, 当AOF文件的大小超过所设定的阈值时，Redis就会启动AOF文件的内容压缩， 只保留可以恢复数据的最小指令集.可以使用命令bgrewriteaof</p>
<p>如何重写?</p>
<p>AOF文件持续增长而过大时，会fork出一条新进程来将文件重写(也是先写临时文件最后再rename)，redis4.0版本后的重写，是指上就是把rdb 的快照，以二级制的形式附在新的aof头部，作为已有的历史数据，替换掉原来的流水账操作。</p>
<p>no-appendfsync-on-rewrite：</p>
<p>如果 no-appendfsync-on-rewrite=yes ,不写入aof文件只写入缓存，用户请求不会阻塞，但是在这段时间如果宕机会丢失这段时间的缓存数据。（降低数据安全性，提高性能）</p>
<p>如果 no-appendfsync-on-rewrite=no, 还是会把数据往磁盘里刷，但是遇到重写操作，可能会发生阻塞。（数据安全，但是性能降低）</p>
<p>触发机制，何时重写？</p>
<p><strong>Redis会记录上次重写时的AOF大小，默认配置是当AOF文件大小是上次rewrite后大小的一倍且文件大于64M时触发</strong></p>
<p><strong>重写虽然可以节约大量磁盘空间，减少恢复时间。但是每次重写还是有一定的负担的，因此设定Redis要满足一定条件才会进行重写。</strong> </p>
<p><strong>auto-aof-rewrite-percentage：设置重写的基准值，文件达到100%时开始重写（文件是原来重写后文件的2倍时触发）</strong></p>
<p><strong>auto-aof-rewrite-min-size：设置重写的基准值，最小文件64MB。达到这个值开始重写。</strong></p>
<p>例如：文件达到70MB开始重写，降到50MB，下次什么时候开始重写？100MB</p>
<p>系统载入时或者上次重写完毕时，Redis会记录此时AOF大小，设为base_size,</p>
<p>如果Redis的AOF当前大小&gt;= base_size +base_size*100% (默认)且当前大小&gt;=64mb(默认)的情况下，Redis会对AOF进行重写。</p>
<h4 id="8-2-4-使用AOF持久化流程"><a href="#8-2-4-使用AOF持久化流程" class="headerlink" title="8.2.4 使用AOF持久化流程"></a>8.2.4 使用AOF持久化流程</h4><p><img src="20221004233837.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<p>（1）bgrewriteaof触发重写，判断是否当前有bgsave或bgrewriteaof在运行，如果有，则等待该命令结束后再继续执行。</p>
<p>（2）主进程fork出子进程执行重写操作，保证主进程不会阻塞。</p>
<p>（3）子进程遍历redis内存中数据到临时文件，客户端的写请求同时写入aof_buf缓冲区和aof_rewrite_buf重写缓冲区保证原AOF文件完整以及新AOF文件生成期间的新的数据修改动作不会丢失。</p>
<p>（4）1).子进程写完新的AOF文件后，向主进程发信号，父进程更新统计信息。2).主进程把aof_rewrite_buf中的数据写入到新的AOF文件。</p>
<p>（5）使用新的AOF文件覆盖旧的AOF文件，完成AOF重写。</p>
<h4 id="8-2-5-AOF持久化特点"><a href="#8-2-5-AOF持久化特点" class="headerlink" title="8.2.5 AOF持久化特点"></a>8.2.5 AOF持久化特点</h4><ul>
<li><p>优势</p>
<ul>
<li>备份机制更稳健，丢失数据概率更低。</li>
<li>可读的日志文本，通过操作AOF稳健，可以处理误操作。</li>
</ul>
</li>
<li><p>劣势</p>
<ul>
<li>比起RDB占用更多的磁盘空间。</li>
<li>恢复备份速度要慢。</li>
<li>每次读写都同步的话，有一定的性能压力。</li>
</ul>
</li>
</ul>
<h4 id="8-2-6-用哪个"><a href="#8-2-6-用哪个" class="headerlink" title="8.2.6 用哪个"></a>8.2.6 用哪个</h4><p>官方推荐两个都启用。</p>
<p><img src="20221004234459.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<ul>
<li><p>RDB持久化方式能够在指定的时间间隔能对你的数据进行快照存储</p>
</li>
<li><p>AOF持久化方式记录每次对服务器写的操作,当服务器重启的时候会重新执行这些命令来恢复原始的数据,AOF命令以redis协议追加保存每次写的操作到文件末尾. </p>
</li>
<li><p>Redis还能对AOF文件进行后台重写,使得AOF文件的体积不至于过大</p>
</li>
<li><p>只做缓存：如果你只希望你的数据在服务器运行的时候存在,你也可以不使用任何持久化方式.</p>
</li>
<li><p>同时开启两种持久化方式</p>
<ul>
<li><p>在这种情况下,当redis重启的时候会优先载入AOF文件来恢复原始的数据, 因为在通常情况下AOF文件保存的数据集要比RDB文件保存的数据集要完整.</p>
</li>
<li><p>RDB的数据不实时，同时使用两者时服务器重启也只会找AOF文件。那要不要只使用AOF呢？ 建议不要，因为RDB更适合用于备份数据库(AOF在不断变化不好备份)， 快速重启，而且不会有AOF可能潜在的bug，留着作为一个万一的手段。</p>
</li>
</ul>
</li>
</ul>
<h2 id="9-redis主从复制"><a href="#9-redis主从复制" class="headerlink" title="9 redis主从复制"></a>9 redis主从复制</h2><p>什么是主从复制?</p>
<p>主机数据更新后根据配置和策略， 自动同步到备机的机制。主机就是master，备机就是slave。</p>
<p>主从复制的机制能干嘛：</p>
<ul>
<li><p>读写分离，性能扩展</p>
</li>
<li><p>容灾快速恢复</p>
</li>
</ul>
<p><img src="20221006132124.png" srcset="/img/loading.gif" lazyload style="zoom:60%"></p>
<h3 id="9-1-搭建一主多从"><a href="#9-1-搭建一主多从" class="headerlink" title="9.1 搭建一主多从"></a>9.1 搭建一主多从</h3><p>如何搭建?</p>
<p>拷贝多个redis.conf文件include(写绝对路径)</p>
<p>开启daemonize yes</p>
<p>Pid文件名字pidfile</p>
<p>指定端口port</p>
<p>Log文件名字</p>
<p>dump.rdb名字dbfilename</p>
<p><strong>appendonly 关掉</strong></p>
<h4 id="9-1-1-搭建步骤"><a href="#9-1-1-搭建步骤" class="headerlink" title="9.1.1 搭建步骤"></a>9.1.1 搭建步骤</h4><ul>
<li><strong>新建一个目录，存放redis的配置文件</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine /]~$ mkdir myredis<br>[qgc@qgc-virtual-machine myredis]~$ cd myredis/<br>[qgc@qgc-virtual-machine myredis]~$ cp /usr/local/bin/redis.conf redis.conf<br>[qgc@qgc-virtual-machine myredis]~$ ll<br>总用量 92<br>-rw-r--r-- 1 root root 92263 9月   2 14:15 redis.conf<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>新建redis6379.conf，在配置文件中定义以下内容</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine myredis]~$ vim redis6379.conf<br></code></pre></td></tr></table></figure>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs txt">include /myredis/redis.conf<br>pidfile /var/run/redis_6379.pid<br>port 6379<br>dbfilename dump6379.rdb<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>新建redis6380.conf，在配置文件中定义以下内容</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine myredis]~$ vim redis6380.conf<br></code></pre></td></tr></table></figure>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs txt">include /myredis/redis.conf<br>pidfile /var/run/redis_6380.pid<br>port 6380<br>dbfilename dump6380.rdb<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>新建redis6381.conf，在配置文件中定义以下内容</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine myredis]~$ vim redis6381.conf<br></code></pre></td></tr></table></figure>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs txt">include /myredis/redis.conf<br>pidfile /var/run/redis_6381.pid<br>port 6381<br>dbfilename dump6381.rdb<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>分别启动三台redis服务器</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine myredis]~$ redis-server redis6379.conf <br>[qgc@qgc-virtual-machine myredis]~$ redis-server redis6380.conf <br>[qgc@qgc-virtual-machine myredis]~$ redis-server redis6381.conf <br>[qgc@qgc-virtual-machine myredis]~$ ps -ef | grep redis<br>root       3012      1  0 14:45 ?        00:00:00 redis-server 127.0.0.1:6379<br>root       3018      1  0 14:46 ?        00:00:00 redis-server 127.0.0.1:6380<br>root       3024      1  0 14:46 ?        00:00:00 redis-server 127.0.0.1:6381<br>root       3030   2541  0 14:46 pts/0    00:00:00 grep --color=auto redis<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>查看三台主机运行情况</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine myredis]~$ redis-cli -p 6379  # 使用客户端连接6379服务器<br>127.0.0.1:6379&gt; info replication  # 查看redis服务器运行情况<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:master  # 角色 主机<br>connected_slaves:0  # 从机数量为0<br>master_failover_state:no-failover<br>master_replid:309b974023e0e99b1a1b9ab508a3cdef86d8b281<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:0<br>second_repl_offset:-1<br>repl_backlog_active:0<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:0<br>repl_backlog_histlen:0<br></code></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine myredis]~$ redis-cli -p 6380  # 使用客户端连接6379服务器<br>127.0.0.1:6380&gt; info replication  # 查看redis服务器运行情况<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:master  # 角色 主机<br>connected_slaves:0  # 从机数量为0<br>master_failover_state:no-failover<br>master_replid:309b974023e0e99b1a1b9ab508a3cdef86d8b281<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:0<br>second_repl_offset:-1<br>repl_backlog_active:0<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:0<br>repl_backlog_histlen:0<br></code></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine myredis]~$ redis-cli -p 6381  # 使用客户端连接6379服务器<br>127.0.0.1:6381&gt; info replication  # 查看redis服务器运行情况<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:master  # 角色 主机<br>connected_slaves:0  # 从机数量为0<br>master_failover_state:no-failover<br>master_replid:309b974023e0e99b1a1b9ab508a3cdef86d8b281<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:0<br>second_repl_offset:-1<br>repl_backlog_active:0<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:0<br>repl_backlog_histlen:0<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>配置从机</strong></li>
</ul>
<p>在6380 6380服务器上配置从机角色。6379是主机，不做任何配置。</p>
<p>在redis6380.conf  6381.conf配置文件上配置从机</p>
<p>首选我们关掉redis三台服务器:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">[qgc@qgc-virtual-machine]~$ </span><span class="language-bash">redis-cli -p 6379 shutdown</span><br><span class="hljs-meta prompt_">[qgc@qgc-virtual-machine]~$ </span><span class="language-bash">redis-cli -p 6380 shutdown</span><br><span class="hljs-meta prompt_">[qgc@qgc-virtual-machine]~$ </span><span class="language-bash">redis-cli -p 6381 shutdown</span><br></code></pre></td></tr></table></figure>
<p>分别在redis6380.conf  6381.conf配置文件中添加： slaveof 127.0.0.1 6379</p>
<ul>
<li><strong>重启三台redis服务器,查看相关的服务器的运行信息</strong></li>
</ul>
<p>重启之后，分别查看相关的服务器的运行信息</p>
<p><strong>redis6379:</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">[qgc@qgc-virtual-machine]~$ </span><span class="language-bash">redis-cli -p 6379</span><br>127.0.0.1:6379&gt; info replication<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:master  # 主机<br>connected_slaves:2  # 从机的数量<br>slave0:ip=127.0.0.1,port=6380,state=online,offset=42,lag=0  # 从机的具体状态<br>slave1:ip=127.0.0.1,port=6381,state=online,offset=28,lag=1  # 从机的具体状态<br>master_failover_state:no-failover<br>master_replid:df8e8d5239e9e60712e03aef99e38dc2954ef428<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:42<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:42<br></code></pre></td></tr></table></figure>
<p><strong>redis6380 redis6381:</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">[qgc@qgc-virtual-machine]~$ </span><span class="language-bash">redis-cli -p 6380</span><br>127.0.0.1:6380&gt; info replication<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:slave  # 角色 从机<br>master_host:127.0.0.1<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:8<br>master_sync_in_progress:0<br>slave_repl_offset:56<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_failover_state:no-failover<br>master_replid:df8e8d5239e9e60712e03aef99e38dc2954ef428<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:56<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:56<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>测试redis主从复制是否可用</strong></li>
</ul>
<p>在主机上添加数据，在从机上查看：</p>
<p>在redis6379机器上设置数据:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; set username eric<br>OK<br></code></pre></td></tr></table></figure>
<p>在从机redis6380 redis6381上查看数据：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6380&gt; get username<br>&quot;eric&quot;<br>127.0.0.1:6381&gt; get username<br>&quot;eric&quot;<br></code></pre></td></tr></table></figure>
<p>在从机上写数据，看是否可以写成功。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6380&gt; set k1 v1<br>(error) READONLY You can&#x27;t write against a read only replica.  # 不能写数据，因为从机只能读数据<br>127.0.0.1:6381&gt; set k2 v2<br>(error) READONLY You can&#x27;t write against a read only replica.<br></code></pre></td></tr></table></figure>
<h4 id="9-1-2-主从复制的原理"><a href="#9-1-2-主从复制的原理" class="headerlink" title="9.1.2 主从复制的原理"></a>9.1.2 主从复制的原理</h4><p>首先我们思考几个问题：</p>
<p><strong>(1) 从机挂掉之后，会出现什么情况</strong></p>
<p>我们先停掉redis6381这台机器。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6381&gt; shutdown<br>not connected&gt; exit<br>[qgc@qgc-virtual-machine myredis]~$ ps -ef | grep redis<br>root       3956      1  0 15:49 ?        00:00:00 redis-server 127.0.0.1:6379<br>root       3962      1  0 15:49 ?        00:00:00 redis-server 127.0.0.1:6380<br>root       3975   3807  0 15:49 pts/0    00:00:00 redis-cli -p 6379<br>root       3987   3864  0 15:49 pts/1    00:00:00 redis-cli -p 6380<br>root       4002   3905  0 15:50 pts2    00:00:00 grep --color=auto redis<br></code></pre></td></tr></table></figure>
<p>接下来我们在主机上新增数据:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; set k1 v1<br>OK<br>127.0.0.1:6379&gt; keys *<br>1) &quot;username&quot;<br>2) &quot;k1&quot;<br></code></pre></td></tr></table></figure>
<p>在6380这台从机上能够同步到主机上的最新的数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6380&gt; keys *<br>1) &quot;k1&quot;<br>2) &quot;username&quot;<br></code></pre></td></tr></table></figure>
<p>接下来我们重启redis6381这台机器。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine myredis]~$ redis-server redis6381.conf <br>[qgc@qgc-virtual-machine myredis]~$ redis-cli -p 6381<br>127.0.0.1:6381&gt; info replication<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:slave  # 重启之后 角色没有发生变化，依然是从机<br>master_host:127.0.0.1<br>master_port:6379<br></code></pre></td></tr></table></figure>
<p>接下来我们查看redis6381这台机器上的数据。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6381&gt; keys *<br>1) &quot;k1&quot;   # 依然能够同步到主机上最新的数据<br>2) &quot;username&quot;<br></code></pre></td></tr></table></figure>
<p><strong>(2) 如果主机挂掉之后，是什么情况</strong></p>
<p>我们关闭主机redis6379的服务。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; shutdown<br>not connected&gt; exit<br>[qgc@qgc-virtual-machine myredis]~$ ps -ef | grep redis<br>root       3962      1  0 15:49 ?        00:00:00 redis-server 127.0.0.1:6380<br>root       3987   3864  0 15:49 pts/1    00:00:00 redis-cli -p 6380<br>root       4022      1  0 15:52 ?        00:00:00 redis-server 127.0.0.1:6381<br>root       4036   3905  0 15:53 pts2    00:00:00 redis-cli -p 6381<br>root       4054   3807  0 15:55 pts/0    00:00:00 grep --color=auto redis<br></code></pre></td></tr></table></figure>
<p>此时从机的状态会发生变化吗?</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6380&gt; info replication  # 从机6380机器上的状态<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:slave<br>master_host:127.0.0.1<br>master_port:6379<br>master_link_status:down<br><br>127.0.0.1:6381&gt; info replication # 从机6381机器上的状态<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:slave<br>master_host:127.0.0.1<br>master_port:6379<br>master_link_status:down<br></code></pre></td></tr></table></figure>
<p><strong>我们发现，不管主机的状态是什么样，从机的角色永远不会发生变化。</strong></p>
<p><strong>(3) 主从复制的原理</strong></p>
<ul>
<li>Slave启动成功连接到master后会发送一个sync命令。</li>
<li>Master接到命令启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令， 在后台进程执行完毕之后，master将传送整个数据文件到slave,以完成一次完全同步。</li>
<li>全量复制：而slave服务在接收到数据库文件数据后，将其存盘并加载到内存中。</li>
<li>增量复制：Master继续将新的所有收集到的修改命令依次传给slave,完成同步。</li>
<li>但是只要是重新连接master,一次完全同步（全量复制)将被自动执行。</li>
</ul>
<p><img src="20221006155905.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<h4 id="9-1-3-redis薪火相传和反客为主"><a href="#9-1-3-redis薪火相传和反客为主" class="headerlink" title="9.1.3 redis薪火相传和反客为主"></a>9.1.3 redis薪火相传和反客为主</h4><h5 id="9-1-3-1-薪火相传"><a href="#9-1-3-1-薪火相传" class="headerlink" title="9.1.3.1 薪火相传"></a>9.1.3.1 薪火相传</h5><p>上一个Slave可以是下一个slave的Master，Slave同样可以接收其他 slaves的连接和同步请求，那么该slave作为了链条中下一个的master, 可以有效减轻master的写压力,去中心化降低风险。</p>
<p><strong>风险是一旦某个slave宕机，后面的slave都没法备份。</strong></p>
<p>现在我们实现薪火相传的效果:</p>
<p><strong>搭建redis6382,注意，redis6382是redis6381的从机。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine myredis]~$ vim redis6382.conf<br></code></pre></td></tr></table></figure>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs txt">include /myredis/redis.conf<br>pidfile /var/run/redis_6382.pid<br>port 6382<br>dbfilename dump6382.rdb<br>slaveof 127.0.0.1 6381  # 不是6379<br></code></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine myredis]~$ redis-server redis6382.conf #启动redis6382<br>[qgc@qgc-virtual-machine myredis]~$ redis-cli -p 6382<br>127.0.0.1:6382&gt; info replication<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:slave<br>master_host:127.0.0.1<br>master_port:6381  # 我们发现6381是6382的主机<br></code></pre></td></tr></table></figure>
<p>我们再查看redis6381的状态：</p>
<p><img src="image-20230902151519367.png" srcset="/img/loading.gif" lazyload alt="image-20230902151519367"></p>
<p>我们发现redis6380既是从机还是6382的主机。</p>
<p><strong>注意:6381还是只能提供读的服务，不能写数据，它的作用是分担了6379机器数据同步的压力。</strong></p>
<h5 id="9-1-3-2-反客为主"><a href="#9-1-3-2-反客为主" class="headerlink" title="9.1.3.2 反客为主"></a>9.1.3.2 反客为主</h5><p>在默认情况下，如果主机挂了，从机的角色不会发生变化，永远都是从机的角色。如果我们想主机挂了之后，从机的角色发生转换，转换成主机，这就叫反客为主。</p>
<ul>
<li>关闭主机redis6379</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; shutdown<br>not connected&gt; exit<br></code></pre></td></tr></table></figure>
<ul>
<li>把从机redis6380设置成主机</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6380&gt; slaveof no one<br>OK<br>127.0.0.1:6380&gt; info replication<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:master<br>127.0.0.1:6380&gt; set k2 v2  # 可以存数据了<br>OK<br></code></pre></td></tr></table></figure>
<ul>
<li>在从机上取数据</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6381&gt; slaveof 127.0.0.1 6380  # 重新指定其主机是6380<br>OK<br>127.0.0.1:6381&gt; keys *<br>1) &quot;k1&quot;<br>2) &quot;username&quot;<br>3) &quot;k2&quot;<br>127.0.0.1:6381&gt; get k2<br>&quot;v2&quot;<br></code></pre></td></tr></table></figure>
<h3 id="9-2-哨兵模式"><a href="#9-2-哨兵模式" class="headerlink" title="9.2 哨兵模式"></a>9.2 哨兵模式</h3><p>什么是哨兵模式：</p>
<p><strong>反客为主的自动版</strong>，能够后台监控主机是否故障，如果故障了根据投票数自动将从节点切换成主节点。</p>
<p><img src="20221006172820.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<h4 id="9-2-1-搭建哨兵模式的步骤"><a href="#9-2-1-搭建哨兵模式的步骤" class="headerlink" title="9.2.1 搭建哨兵模式的步骤"></a>9.2.1 搭建哨兵模式的步骤</h4><ul>
<li>将机器恢复成6379 6380 6381</li>
</ul>
<p>其中6379是主节点。6380   6381是从节点。分别启动这三台redis服务。</p>
<ul>
<li>在myredis目录里面创建一个文件，文件的名称为<strong>sentinel.conf</strong>。注意名字必须叫这个。</li>
</ul>
<p>在sentinel.conf配置文件里面定义如下内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">sentinel monitor mymaster 127.0.0.1 6379 1<br><span class="hljs-meta prompt_"># </span><span class="language-bash">daemonize <span class="hljs-built_in">yes</span> <span class="hljs-comment"># yes表示后台启动</span></span><br></code></pre></td></tr></table></figure>
<p>其中mymaster为监控对象起的服务器名称， 1 为至少有多少个哨兵同意迁移的数量。</p>
<ul>
<li>启动哨兵</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine myredis]~$ redis-sentinel sentinel.conf<br></code></pre></td></tr></table></figure>
<p><img src="image-20230902153746240.png" srcset="/img/loading.gif" lazyload alt="image-20230902153746240"></p>
<p>我们可以看到哨兵监控的具体信息:</p>
<p><img src="image-20230902154006054.png" srcset="/img/loading.gif" lazyload alt="image-20230902154006054"></p>
<ul>
<li>将主机redis6379停掉</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine myredis]~$ redis-cli -p 6379 shutdown<br></code></pre></td></tr></table></figure>
<p>我们再看sentinel控制台的输出(此时需要等待一定的时间)，我们可以看到切换主机的一些日志信息：</p>
<p><img src="image-20230902155923831.png" srcset="/img/loading.gif" lazyload alt="image-20230902155923831"></p>
<ul>
<li>查看redis6381的服务器运行信息</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine ~]~$ redis-cli -p 6381<br>127.0.0.1:6381&gt; info replication<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:master  # 变成了主机<br>connected_slaves:1<br>slave0:ip=127.0.0.1,port=6380,state=online,offset=36593,lag=0<br>master_failover_state:no-failover<br>master_replid:b6ff983efa23cafad22380a6d9d270eadcb69e99<br>master_replid2:8b338cbee4b296b50621911fd89d26d68c110b14<br>master_repl_offset:36593<br>second_repl_offset:14976<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:36593<br></code></pre></td></tr></table></figure>
<ul>
<li>接下来我们重新启动redis6379服务器</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine myredis]~$ redis-cli -p 6379 shutdown<br>[qgc@qgc-virtual-machine myredis]~$ redis-server redis6379.conf <br>[qgc@qgc-virtual-machine myredis]~$ redis-cli -p 6379<br>127.0.0.1:6379&gt; info replication<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:slave  # 6379变成了从服务器了<br>master_host:127.0.0.1<br>master_port:6381<br></code></pre></td></tr></table></figure>
<p>现在我们完成了哨兵的配置。</p>
<h4 id="9-2-2-哨兵的选举策略"><a href="#9-2-2-哨兵的选举策略" class="headerlink" title="9.2.2 哨兵的选举策略"></a>9.2.2 哨兵的选举策略</h4><p>通过上面的操作，我们指定当从节点挂掉之后，哨兵会选出新的主节点，那么它的选举策略是什么呢?</p>
<p><strong>(1) 选择优先级靠前的。</strong></p>
<p>优先级在redis.conf中默认：replica-priority 100，值越小优先级越高</p>
<p><img src="20221006180734.png" srcset="/img/loading.gif" lazyload style="zoom:90%"></p>
<p><strong>(2) 选择偏移量最大的。</strong></p>
<p>偏移量是指获得原主机数据最全的。</p>
<p><strong>(3) 选择runid最小的服务。</strong></p>
<p>每个redis实例启动后都会随机生成一个40位的runid。</p>
<h2 id="10-redis集群"><a href="#10-redis集群" class="headerlink" title="10 redis集群"></a>10 redis集群</h2><h3 id="10-1-redis集群的基本介绍"><a href="#10-1-redis集群的基本介绍" class="headerlink" title="10.1 redis集群的基本介绍"></a>10.1 redis集群的基本介绍</h3><p>首先我们来思考一个问题：</p>
<p>如果redis容量不够了，数据写不进去了，redis如何扩容?</p>
<p>如果redis的并发操作大，redis如何分摊并发压力?</p>
<p>另外，主从模式，薪火相传模式，主机宕机，导致ip地址发生变化，应用程序中配置需要修改对应的主机地址、端口等信息。</p>
<p>之前通过<strong>代理主机</strong>来解决，但是redis3.0中提供了解决方案。<strong>就是无中心化集群配置。</strong></p>
<h3 id="10-2-搭建redis集群"><a href="#10-2-搭建redis集群" class="headerlink" title="10.2 搭建redis集群"></a>10.2 搭建redis集群</h3><p>redis集群有什么特点:</p>
<p>Redis 集群实现了对Redis的水平扩容，即启动N个redis节点，将整个数据库分布存储在这N个节点中，每个节点存储总数据的1/N。</p>
<p>Redis 集群通过分区（partition）来提供一定程度的可用性（availability）： 即使集群中有一部分节点失效或者无法进行通讯， 集群也可以继续处理命令请求。</p>
<p>接下来我们开始redis集群的具体搭建：</p>
<ul>
<li><strong>创建新的目录</strong></li>
</ul>
<p>创建目录redis-cluster，将之前搭建主从复制的redis.conf拷贝到当前目录。</p>
<p><strong>注意：redis.conf配置文件一定要设置成远程登录，否则搭建集群不成功。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine /]~$ mkdir redis-cluster<br>[qgc@qgc-virtual-machine /]~$ cd redis-cluster<br>[qgc@qgc-virtual-machine redis-cluster]~$ cp /myredis/redis.conf redis.conf<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>我们搭建3主3从，所以我们创建6个redis实例。</strong></li>
</ul>
<p>6个redis实例的端口号分别是<strong>6379,6380,6381,6389,6390,6391。</strong> </p>
<p>创建redis配置文件redis6379.conf，配置文件里面定义如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">include /redis-cluster/redis.conf<br>pidfile /var/run/redis_6379.pid<br>port 6379<br>dbfilename dump6379.rdb<br>cluster-enabled yes<br>cluster-config-file nodes-6379.conf<br>cluster-node-timeout 15000<br></code></pre></td></tr></table></figure>
<p>注意：</p>
<p>cluster-enabled yes  打开集群模式</p>
<p>cluster-config-file nodes-6379.conf 设定节点配置文件名</p>
<p>cluster-node-timeout 15000  设定节点失联时间，超过该时间（毫秒），集群自动进行主从切换。</p>
<ul>
<li><strong>复制其他节点的配置文件</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine redis-cluster]~$ cp redis6379.conf redis6380.conf<br>[qgc@qgc-virtual-machine redis-cluster]~$ cp redis6379.conf redis6381.conf<br>[qgc@qgc-virtual-machine redis-cluster]~$ cp redis6379.conf redis6389.conf<br>[qgc@qgc-virtual-machine redis-cluster]~$ cp redis6379.conf redis6390.conf<br>[qgc@qgc-virtual-machine redis-cluster]~$ cp redis6379.conf redis6391.conf<br>[qgc@qgc-virtual-machine redis-cluster]~$ ll<br>总用量 24<br>-rw-r--r-- 1 root root   168 9月   2 16:08 redis6379.conf<br>-rw-r--r-- 1 root root   168 9月   2 16:08 redis6380.conf<br>-rw-r--r-- 1 root root   168 9月   2 16:08 redis6381.conf<br>-rw-r--r-- 1 root root   168 9月   2 16:08 redis6389.conf<br>-rw-r--r-- 1 root root   168 9月   2 16:08 redis6390.conf<br>-rw-r--r-- 1 root root   168 9月   2 16:08 redis6391.conf<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>将配置文件里面的内容进行修改</strong></li>
</ul>
<p>可以使用查找并替换的命令来实现</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">:%s/6379/6380<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>启动6个redis服务</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine redis-cluster]~$ redis-server redis6379.conf <br>[qgc@qgc-virtual-machine redis-cluster]~$ redis-server redis6380.conf <br>[qgc@qgc-virtual-machine redis-cluster]~$ redis-server redis6381.conf <br>[qgc@qgc-virtual-machine redis-cluster]~$ redis-server redis6389.conf <br>[qgc@qgc-virtual-machine redis-cluster]~$ redis-server redis6390.conf <br>[qgc@qgc-virtual-machine redis-cluster]~$ redis-server redis6391.conf <br></code></pre></td></tr></table></figure>
<p>查看redis服务启动状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine redis-cluster]~$ ps -ef | grep redis<br>root       8673      1  0 22:56 ?        00:00:00 redis-server 127.0.0.1:6379 [cluster]<br>root       8679      1  0 22:56 ?        00:00:00 redis-server 127.0.0.1:6380 [cluster]<br>root       8685      1  0 22:56 ?        00:00:00 redis-server 127.0.0.1:6381 [cluster]<br>root       8691      1  0 22:56 ?        00:00:00 redis-server 127.0.0.1:6389 [cluster]<br>root       8697      1  0 22:56 ?        00:00:00 redis-server 127.0.0.1:6390 [cluster]<br>root       8703      1  0 22:56 ?        00:00:00 redis-server 127.0.0.1:6391 [cluster]<br>root       8483   6637  0 22:45 pts/0    00:00:00 grep --color=auto redis<br></code></pre></td></tr></table></figure>
<p>注意：如果搭建成功，当前目录下面必须存在以nodes-开头的文件</p>
<p><img src="image-20230902162133335.png" srcset="/img/loading.gif" lazyload alt="image-20230902162133335"></p>
<ul>
<li><strong>将6个节点合并成一个集群</strong></li>
</ul>
<p><strong>合并集群之前，请确保所有redis实例启动后，nodes-xxxx.conf文件都生成正常。</strong></p>
<p>先进入到最先安装redis的src目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine /]~$ cd  /opt/redis-6.2.1/src<br>[qgc@qgc-virtual-machine src]~$ ls<br></code></pre></td></tr></table></figure>
<p><img src="20221006231006-1693643011635-20.png" srcset="/img/loading.gif" lazyload style="zoom:70%"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine src]~$ redis-cli --cluster create --cluster-replicas 1 192.168.84.128:6379 192.168.84.128:6380 192.168.84.128:6381 192.168.84.128:6389 192.168.84.128:6390 192.168.84.128:6391<br></code></pre></td></tr></table></figure>
<p><strong>注意：</strong></p>
<ul>
<li><p><strong>此处不要用127.0.0.1， 请用真实IP地址，请用ifconfig查看IP。</strong></p>
</li>
<li><p><strong>关于错误的解决方案</strong><img src="image-20230902163633612.png" srcset="/img/loading.gif" lazyload alt="image-20230902163633612"></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44829930/article/details/117558512">彻底解决：[ERR] Node is not empty. Either the node already knows other nodes_生命中有太多不确定的博客-CSDN博客</a></p>
</li>
</ul>
<p>**—replicas 1 采用最简单的方式配置集群，</p>
<p><strong>—replicas 1 采用最简单的方式配置集群，一台主机，一台从机，正好三组。</strong></p>
<p>执行命令，之后，效果如下:</p>
<p><img src="image-20230902163526991.png" srcset="/img/loading.gif" lazyload alt="image-20230902163526991"></p>
<p>我们输入yes，表示接受以上配置：</p>
<p><img src="image-20230902163547260.png" srcset="/img/loading.gif" lazyload alt="image-20230902163547260"></p>
<p>如果出现以上信息说明集群搭建成功。</p>
<ul>
<li><strong>连接集群</strong></li>
</ul>
<p>使用连接集群的命令： redis-cli -c -p 6379</p>
<p>-c:指的使用集群的方式连接redis。</p>
<p>-p：指定参数，这里任意参数都可以。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[qgc@qgc-virtual-machine src]~$ redis-cli -c -p 6379<br>127.0.0.1:6379&gt; cluster nodes # 查看集群的具体情况在<br></code></pre></td></tr></table></figure>
<h3 id="10-3-redis集群的详细细节"><a href="#10-3-redis集群的详细细节" class="headerlink" title="10.3 redis集群的详细细节"></a>10.3 redis集群的详细细节</h3><p>一个集群至少要有三个主节点。</p>
<p>选项 —cluster-replicas 1 表示我们希望为集群中的每个主节点创建一个从节点。</p>
<p><strong>分配原则尽量保证每个主数据库运行在不同的IP地址，每个从库和主库不在一个IP地址上。</strong></p>
<h4 id="10-3-1-什么是slots"><a href="#10-3-1-什么是slots" class="headerlink" title="10.3.1 什么是slots"></a>10.3.1 什么是slots</h4><p><img src="20221007000923.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<p>一个 Redis 集群包含 16384 个插槽（hash slot）， 数据库中的每个键都属于这 16384 个插槽的其中一个。</p>
<p>集群使用公式 CRC16(key) % 16384 来计算键 key 属于哪个槽， 其中 CRC16(key) 语句用于计算键 key 的 CRC16 校验和 。</p>
<p>集群中的每个节点负责处理一部分插槽。 举个例子， 如果一个集群可以有主节点， 其中：</p>
<p>节点 A 负责处理 0 号至 5460 号插槽。</p>
<p>节点 B 负责处理 5461 号至 10922 号插槽。</p>
<p>节点 C 负责处理 10923 号至 16383 号插槽。</p>
<h4 id="10-3-2-在集群模式写写入数据"><a href="#10-3-2-在集群模式写写入数据" class="headerlink" title="10.3.2 在集群模式写写入数据"></a>10.3.2 在集群模式写写入数据</h4><p>接下来我们在集群中插入数据:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; set k1 v1<br><span class="hljs-meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [12706] located at 192.168.84.128:6381</span><br>OK<br>192.168.84.128:6381&gt; set k2 v2<br><span class="hljs-meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [449] located at 192.168.84.128:6379</span><br>OK<br>192.168.84.128:6379&gt;<br></code></pre></td></tr></table></figure>
<p><strong>注意：不在一个slot下的键值，是不能使用mget,mset等多键操作。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">192.168.84.128:6379&gt; mset username eric age 20<br>(error) CROSSSLOT Keys in request don&#x27;t hash to the same slot   # 此时报错<br></code></pre></td></tr></table></figure>
<p>我们可以通过{}来定义组的概念，从而使key中{}内相同内</p>
<p>容的键值对放到一个slot中去。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">192.168.84.128:6379&gt; mset username&#123;group1&#125; eric age&#123;group1&#125; 20<br><span class="hljs-meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [7859] located at 192.168.84.128:6380</span><br>OK<br>192.168.84.128:6380&gt;<br></code></pre></td></tr></table></figure>
<h4 id="10-3-3-查询集群中的值"><a href="#10-3-3-查询集群中的值" class="headerlink" title="10.3.3 查询集群中的值"></a>10.3.3 查询集群中的值</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">192.168.84.128:6380&gt; cluster keyslot k2  # 计算key的插槽值<br>(integer) 449<br>192.168.84.128:6380&gt; get k1<br><span class="hljs-meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [12706] located at 192.168.84.128:6381</span><br>&quot;v1&quot;<br>192.168.84.128:6381&gt; get k2<br><span class="hljs-meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [449] located at 192.168.84.128:6379</span><br>&quot;v2&quot;<br>192.168.84.128:6381&gt; get username&#123;group1&#125;<br><span class="hljs-meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [7859] located at 192.168.84.128:6380</span><br>&quot;eric&quot;<br>192.168.84.128:6380&gt; get age&#123;group1&#125;<br>&quot;20&quot;<br></code></pre></td></tr></table></figure>
<h4 id="10-3-4-redis集群的故障恢复"><a href="#10-3-4-redis集群的故障恢复" class="headerlink" title="10.3.4 redis集群的故障恢复"></a>10.3.4 redis集群的故障恢复</h4><p>在redis集群中，如果某一个主节点挂掉(下线)，会出现什么样的后果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">192.168.84.128:6379&gt; shutdown  # 将6379服务停掉<br>not connected&gt; exit<br></code></pre></td></tr></table></figure>
<p><img src="image-20230903071255767.png" srcset="/img/loading.gif" lazyload alt="image-20230903071255767"></p>
<p>现在我们重新启动6379这台机器，我们重新打开一个终端来启动:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@java2201 src]~$ cd /redis-cluster/<br>[root@java2201 redis-cluster]~$ redis-server redis6379.conf <br></code></pre></td></tr></table></figure>
<p><img src="image-20230903071625051.png" srcset="/img/loading.gif" lazyload alt="image-20230903071625051"></p>
<p>如果所有某一段插槽的主从节点都宕掉，redis服务是否还能继续?</p>
<p>如果某一段插槽的主从都挂掉，而cluster-require-full-coverage 为yes ，那么 ，整个集群都挂掉</p>
<p>如果某一段插槽的主从都挂掉，而cluster-require-full-coverage 为no ，那么，该插槽数据全都不能使用，也无法存储。</p>
<p>redis.conf中的参数 cluster-require-full-coverage</p>
<h2 id="11-Jedis操作"><a href="#11-Jedis操作" class="headerlink" title="11 Jedis操作"></a>11 Jedis操作</h2><p>前期准备工作:</p>
<p>禁用Linux的防火墙：Linux(CentOS7)里执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl stop/disable firewalld.service<br></code></pre></td></tr></table></figure>
<p><strong>redis.conf中注释掉bind 127.0.0.1 ,然后 protected-mode no</strong></p>
<h3 id="11-1-搭建maven工程，测试jedis"><a href="#11-1-搭建maven工程，测试jedis" class="headerlink" title="11.1 搭建maven工程，测试jedis"></a>11.1 搭建maven工程，测试jedis</h3><ul>
<li>创建maven工程，引入相关的依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>redis.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jedis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>
<ul>
<li>创建测试程序</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestJedis</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test01</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.84.128&quot;</span>,<span class="hljs-number">6379</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">pong</span> <span class="hljs-operator">=</span> jedis.ping();<br>        System.out.println(<span class="hljs-string">&quot;连接成功：&quot;</span>+pong);<br>        jedis.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="11-2-Jedis的基本使用"><a href="#11-2-Jedis的基本使用" class="headerlink" title="11.2 Jedis的基本使用"></a>11.2 Jedis的基本使用</h3><h4 id="11-2-1-使用jedis操作redis常用的数据类型"><a href="#11-2-1-使用jedis操作redis常用的数据类型" class="headerlink" title="11.2.1 使用jedis操作redis常用的数据类型"></a>11.2.1 使用jedis操作redis常用的数据类型</h4><ul>
<li>跟key相关的操作</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test02</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.84.128&quot;</span>,<span class="hljs-number">6379</span>);<br>    jedis.set(<span class="hljs-string">&quot;k1&quot;</span>, <span class="hljs-string">&quot;v1&quot;</span>);<br>    jedis.set(<span class="hljs-string">&quot;k2&quot;</span>, <span class="hljs-string">&quot;v2&quot;</span>);<br>    jedis.set(<span class="hljs-string">&quot;k3&quot;</span>, <span class="hljs-string">&quot;v3&quot;</span>);<br>    Set&lt;String&gt; keys = jedis.keys(<span class="hljs-string">&quot;*&quot;</span>);<br>    System.out.println(keys.size());<br>    <span class="hljs-keyword">for</span> (String key : keys) &#123;<br>        System.out.println(key);<br>    &#125;<br>    System.out.println(jedis.exists(<span class="hljs-string">&quot;k1&quot;</span>));<br>    System.out.println(jedis.ttl(<span class="hljs-string">&quot;k1&quot;</span>));<br>    System.out.println(jedis.get(<span class="hljs-string">&quot;k1&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>操作String</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test03</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.84.128&quot;</span>,<span class="hljs-number">6379</span>);<br>    jedis.mset(<span class="hljs-string">&quot;str1&quot;</span>,<span class="hljs-string">&quot;v1&quot;</span>,<span class="hljs-string">&quot;str2&quot;</span>,<span class="hljs-string">&quot;v2&quot;</span>,<span class="hljs-string">&quot;str3&quot;</span>,<span class="hljs-string">&quot;v3&quot;</span>);<br>    System.out.println(jedis.mget(<span class="hljs-string">&quot;str1&quot;</span>,<span class="hljs-string">&quot;str2&quot;</span>,<span class="hljs-string">&quot;str3&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>操作list</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test02</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.84.128&quot;</span>,<span class="hljs-number">6379</span>);<br>    jedis.rpush(<span class="hljs-string">&quot;mylist&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;c&quot;</span>,<span class="hljs-string">&quot;d&quot;</span>);<br>    List&lt;String&gt; list = jedis.lrange(<span class="hljs-string">&quot;mylist&quot;</span>,<span class="hljs-number">0</span>,-<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">for</span> (String element : list) &#123;<br>        System.out.println(element);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>操作set</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test02</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.84.128&quot;</span>,<span class="hljs-number">6379</span>);<br>    jedis.sadd(<span class="hljs-string">&quot;myset&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;c&quot;</span>,<span class="hljs-string">&quot;d&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>);<br>    Set&lt;String&gt; smembers = jedis.smembers(<span class="hljs-string">&quot;myset&quot;</span>);<br>    <span class="hljs-keyword">for</span> (String order : smembers) &#123;<br>        System.out.println(order);<br>    &#125;<br>    jedis.srem(<span class="hljs-string">&quot;myset&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>操作hash</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test02</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.84.128&quot;</span>,<span class="hljs-number">6379</span>);<br>    jedis.hset(<span class="hljs-string">&quot;hash1&quot;</span>,<span class="hljs-string">&quot;userName&quot;</span>,<span class="hljs-string">&quot;lisi&quot;</span>);<br>    System.out.println(jedis.hget(<span class="hljs-string">&quot;hash1&quot;</span>,<span class="hljs-string">&quot;userName&quot;</span>));<br>    Map&lt;String,String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String,String&gt;();<br>    map.put(<span class="hljs-string">&quot;telphone&quot;</span>,<span class="hljs-string">&quot;13810169999&quot;</span>);<br>    map.put(<span class="hljs-string">&quot;address&quot;</span>,<span class="hljs-string">&quot;atguigu&quot;</span>);<br>    map.put(<span class="hljs-string">&quot;email&quot;</span>,<span class="hljs-string">&quot;abc@163.com&quot;</span>);<br>    jedis.hmset(<span class="hljs-string">&quot;hash2&quot;</span>,map);<br>    List&lt;String&gt; result = jedis.hmget(<span class="hljs-string">&quot;hash2&quot;</span>, <span class="hljs-string">&quot;telphone&quot;</span>,<span class="hljs-string">&quot;email&quot;</span>);<br>    <span class="hljs-keyword">for</span> (String element : result) &#123;<br>        System.out.println(element);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>操作zset</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test02</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.84.128&quot;</span>,<span class="hljs-number">6379</span>);<br>    jedis.zadd(<span class="hljs-string">&quot;zset01&quot;</span>, <span class="hljs-number">100d</span>, <span class="hljs-string">&quot;z3&quot;</span>);<br>    jedis.zadd(<span class="hljs-string">&quot;zset01&quot;</span>, <span class="hljs-number">90d</span>, <span class="hljs-string">&quot;l4&quot;</span>);<br>    jedis.zadd(<span class="hljs-string">&quot;zset01&quot;</span>, <span class="hljs-number">80d</span>, <span class="hljs-string">&quot;w5&quot;</span>);<br>    jedis.zadd(<span class="hljs-string">&quot;zset01&quot;</span>, <span class="hljs-number">70d</span>, <span class="hljs-string">&quot;z6&quot;</span>);<br><br>    Set&lt;String&gt; zrange = jedis.zrange(<span class="hljs-string">&quot;zset01&quot;</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">for</span> (String e : zrange) &#123;<br>        System.out.println(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="11-2-2-使用jedis连接池改造jedis操作"><a href="#11-2-2-使用jedis连接池改造jedis操作" class="headerlink" title="11.2.2 使用jedis连接池改造jedis操作"></a>11.2.2 使用jedis连接池改造jedis操作</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test03</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">JedisPoolConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPoolConfig</span>();<br>    config.setMaxTotal(<span class="hljs-number">50</span>);<br>    config.setMinIdle(<span class="hljs-number">10</span>);<br>    <span class="hljs-type">JedisPool</span> <span class="hljs-variable">jedisPool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPool</span>(config,<span class="hljs-string">&quot;192.168.84.128&quot;</span>,<span class="hljs-number">6379</span>);<br>    <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource();<br>    jedis.set(<span class="hljs-string">&quot;username&quot;</span>,<span class="hljs-string">&quot;eric&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">&quot;username&quot;</span>);<br>    System.out.println(username);<br>    jedis.close();<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="11-2-3-抽取工具类，优化连接池代码"><a href="#11-2-3-抽取工具类，优化连接池代码" class="headerlink" title="11.2.3 抽取工具类，优化连接池代码"></a>11.2.3 抽取工具类，优化连接池代码</h4><ul>
<li>定义一个配置连接池的properties文件(redis.properties)，然后放置在resources目录下面。</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">maxTotal</span>=<span class="hljs-string">200</span><br><span class="hljs-attr">maxIdle</span>=<span class="hljs-string">50</span><br></code></pre></td></tr></table></figure>
<ul>
<li>定义一个工具类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisUtils</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> JedisPool jedisPool;<br><br>    <span class="hljs-keyword">static</span>&#123;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> RedisUtils.class.getClassLoader().getResourceAsStream(<span class="hljs-string">&quot;redis.properties&quot;</span>);<br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>            properties.load(in);<br>            <span class="hljs-type">JedisPoolConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPoolConfig</span>();<br>            config.setMaxTotal(Integer.parseInt(properties.getProperty(<span class="hljs-string">&quot;maxTotal&quot;</span>)));<br>            config.setMinIdle(Integer.parseInt(properties.getProperty(<span class="hljs-string">&quot;maxIdle&quot;</span>)));<br>            jedisPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPool</span>(config,<span class="hljs-string">&quot;192.168.84.128&quot;</span>,<span class="hljs-number">6379</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Jedis <span class="hljs-title function_">getJedis</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> jedisPool.getResource();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>定义测试类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test04</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> RedisUtils.getJedis();<br>    jedis.set(<span class="hljs-string">&quot;subject&quot;</span>,<span class="hljs-string">&quot;java&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">subject</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">&quot;subject&quot;</span>);<br>    System.out.println(subject);<br>    jedis.close();<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="11-3-jedis案例"><a href="#11-3-jedis案例" class="headerlink" title="11.3 jedis案例"></a>11.3 jedis案例</h3><p>需求：使用异步请求，动态加载下拉框省份信息。要求将省份信息保存在缓存里面。</p>
<h4 id="11-3-1-搭建maven工程-使用骨架创建web项目-，导入相关的依赖"><a href="#11-3-1-搭建maven工程-使用骨架创建web项目-，导入相关的依赖" class="headerlink" title="11.3.1 搭建maven工程(使用骨架创建web项目)，导入相关的依赖"></a>11.3.1 搭建maven工程(使用骨架创建web项目)，导入相关的依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">spring.version</span>&gt;</span>5.0.2.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">slf4j.version</span>&gt;</span>1.6.6<span class="hljs-tag">&lt;/<span class="hljs-name">slf4j.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">log4j.version</span>&gt;</span>1.2.12<span class="hljs-tag">&lt;/<span class="hljs-name">log4j.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">oracle.version</span>&gt;</span>11.2.0.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">oracle.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mybatis.version</span>&gt;</span>3.4.5<span class="hljs-tag">&lt;/<span class="hljs-name">mybatis.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">spring.security.version</span>&gt;</span>5.0.1.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring.security.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mysql.version</span>&gt;</span>5.1.6<span class="hljs-tag">&lt;/<span class="hljs-name">mysql.version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- spring --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.aspectj<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aspectjweaver<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.6.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context-support<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-orm<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-beans<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-webmvc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-tx<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.servlet<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javax.servlet-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.servlet.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jsp-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>jstl<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jstl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- log start --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;log4j.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;slf4j.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-log4j12<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;slf4j.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- log end --&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mybatis.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>redis.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jedis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--json工具--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-databind<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-annotations<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>
<h4 id="11-3-2-编写jsp页面"><a href="#11-3-2-编写jsp页面" class="headerlink" title="11.3.2 编写jsp页面"></a>11.3.2 编写jsp页面</h4><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> isELIgnored=<span class="hljs-string">&quot;false&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>    &lt;select name=<span class="hljs-string">&quot;province&quot;</span> id=<span class="hljs-string">&quot;province&quot;</span>&gt;<br>        &lt;option&gt;请选择&lt;/option&gt;<br>    &lt;/select&gt;<br>&lt;/body&gt;<br>&lt;script src=<span class="hljs-string">&quot;http://code.jquery.com/jquery-2.1.4.min.js&quot;</span>&gt;&lt;/script&gt;<br>&lt;script type=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;<br>    $(function()&#123;<br>        $.ajax(&#123;<br>            type:<span class="hljs-string">&quot;GET&quot;</span>,<br>            url:<span class="hljs-string">&quot;$&#123;pageContext.request.contextPath&#125;/province/findAll&quot;</span>,<br>            contentType:<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>,<br>            dataType:<span class="hljs-string">&quot;json&quot;</span>,<br>            success:function(data)&#123;<br>               $(data).each(function()&#123;<br>                   <span class="hljs-type">var</span> <span class="hljs-variable">option</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&lt;option id=&quot;</span>+<span class="hljs-built_in">this</span>.id+<span class="hljs-string">&quot;&gt;&quot;</span>+<span class="hljs-built_in">this</span>.name+<span class="hljs-string">&quot;&lt;/option&gt;&quot;</span>;<br>                   $(<span class="hljs-string">&quot;#province&quot;</span>).append(option);<br>               &#125;)<br>            &#125;<br>        &#125;)<br>    &#125;)<br>&lt;/script&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>
<h4 id="11-3-3-搭建SSM环境"><a href="#11-3-3-搭建SSM环境" class="headerlink" title="11.3.3 搭建SSM环境"></a>11.3.3 搭建SSM环境</h4><ul>
<li>编写web.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--加载spring配置文件的路径--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">context-param</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>contextConfigLocation<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>classpath:applicationContext.xml<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">context-param</span>&gt;</span><br><br>  <span class="hljs-comment">&lt;!-- 解决中文乱码过滤器 --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>characterEncodingFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>encoding<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>characterEncodingFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span><br><br><br>  <span class="hljs-comment">&lt;!--配置监听器--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="hljs-tag">&lt;/<span class="hljs-name">listener-class</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span><br><br><br>  <span class="hljs-comment">&lt;!--配置前端控制器--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>dispatcherServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--加载springmvc配置文件--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>contextConfigLocation<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>classpath:springmvc.xml<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>dispatcherServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span><br></code></pre></td></tr></table></figure>
<ul>
<li>编写applicationContext.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span> <span class="hljs-attr">xmlns:tx</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/tx&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">                           http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--包扫描--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">&quot;com.xq&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">context:exclude-filter</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;annotation&quot;</span> <span class="hljs-attr">expression</span>=<span class="hljs-string">&quot;org.springframework.stereotype.Controller&quot;</span>&gt;</span>           <span class="hljs-tag">&lt;/<span class="hljs-name">context:exclude-filter</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">context:component-scan</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--加载外部的properties配置文件--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span> <span class="hljs-attr">location</span>=<span class="hljs-string">&quot;classpath:db.properties&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">context:property-placeholder</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--配置数据源--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;driverClassName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.driver&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.url&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.username&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.password&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--配置SqlSessionFactoryBean--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;sqlSessionFactoryBean&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;dataSource&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--配置MapperScannerConfigure--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;mapperScannerConfigurer&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;basePackage&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;com.xq.dao&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--配置redis--&gt;</span><br>    <span class="hljs-comment">&lt;!--配置JedisPoolConfig--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;jedisPoolConfig&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;redis.clients.jedis.JedisPoolConfig&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;maxTotal&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;redis.pool.maxActive&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;maxIdle&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;redis.pool.maxIdle&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;minIdle&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;redis.pool.minIdle&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;maxWaitMillis&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;redis.pool.maxWaitMillis&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--管理JedisPool--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;jedisPool&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;redis.clients.jedis.JedisPool&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;poolConfig&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;jedisPoolConfig&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">constructor-arg</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;host&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;redis.host&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">constructor-arg</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--配置平台事务管理器--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;transactionManager&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;dataSource&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--开启注解对事务的支持--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">tx:annotation-driven</span> <span class="hljs-attr">transaction-manager</span>=<span class="hljs-string">&quot;transactionManager&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">tx:annotation-driven</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>
<ul>
<li>编写springmvc.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:mvc</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/context</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/context/spring-context.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/mvc</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/mvc/spring-mvc.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">   &quot;</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--包扫描--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">&quot;com.xq&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">context:include-filter</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;annotation&quot;</span> <span class="hljs-attr">expression</span>=<span class="hljs-string">&quot;org.springframework.stereotype.Controller&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">context:include-filter</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">context:component-scan</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 设置静态资源不过滤 --&gt;</span><br>    <span class="hljs-comment">&lt;!-- &lt;mvc:resources location=&quot;/css/&quot; mapping=&quot;/css/**&quot;/&gt;</span><br><span class="hljs-comment">    &lt;mvc:resources location=&quot;img/&quot; mapping=&quot;img/**&quot; /&gt;</span><br><span class="hljs-comment">    &lt;mvc:resources location=&quot;/plugins/&quot; mapping=&quot;/plugins/**&quot; /&gt;</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-comment">&lt;!--配置视图解析器--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;viewResolver&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;prefix&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/pages/&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;suffix&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;.jsp&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--开启对处理器映射器 处理器适配器的支持--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mvc:annotation-driven</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">mvc:annotation-driven</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>
<ul>
<li>编写db.properties</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># mysql的配置信息</span><br><span class="hljs-attr">jdbc.driver</span>=<span class="hljs-string">com.mysql.jdbc.Driver</span><br><span class="hljs-attr">jdbc.url</span>=<span class="hljs-string">jdbc:mysql://192.168.10.130:3306/redis</span><br><span class="hljs-attr">jdbc.username</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">jdbc.password</span>=<span class="hljs-string">Admin2022!</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># redis的配置信息</span><br><span class="hljs-comment"># 最大分配的对象数</span><br><span class="hljs-attr">redis.pool.maxActive</span>=<span class="hljs-string">200</span><br><span class="hljs-comment"># 最大能够保持idel状态的对象数</span><br><span class="hljs-attr">redis.pool.maxIdle</span>=<span class="hljs-string">50</span><br><span class="hljs-attr">redis.pool.minIdle</span>=<span class="hljs-string">10</span><br><span class="hljs-attr">redis.pool.maxWaitMillis</span>=<span class="hljs-string">20000</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">#  连接redis的主机和端口号</span><br><span class="hljs-attr">redis.host</span> = <span class="hljs-string">192.168.10.130</span><br></code></pre></td></tr></table></figure>
<ul>
<li>编写log4j.properties</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">log4j.rootLogger</span>=<span class="hljs-string">DEBUG,myConsole</span><br><span class="hljs-attr">log4j.appender.myConsole</span>=<span class="hljs-string">org.apache.log4j.ConsoleAppender</span><br><span class="hljs-attr">log4j.appender.myConsole.ImmediateFlush</span>=<span class="hljs-string">true</span><br><span class="hljs-attr">log4j.appender.myConsole.Target</span>=<span class="hljs-string">System.out</span><br><span class="hljs-attr">log4j.appender.myConsole.layout</span>=<span class="hljs-string">org.apache.log4j.PatternLayout</span><br><span class="hljs-attr">log4j.appender.myConsole.layout.ConversionPattern</span>=<span class="hljs-string">[%-5p] %d(%r) --&gt; [%t] %l: %m %x %n</span><br><br><span class="hljs-attr">log4j.logger.com.mchange.v2</span>=<span class="hljs-string">ERROR</span><br></code></pre></td></tr></table></figure>
<h4 id="11-3-4-编写实体类"><a href="#11-3-4-编写实体类" class="headerlink" title="11.3.4 编写实体类"></a>11.3.4 编写实体类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Province</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Province&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;id=&quot;</span> + id +<br>                <span class="hljs-string">&quot;, name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="11-3-5-编写dao"><a href="#11-3-5-编写dao" class="headerlink" title="11.3.5 编写dao"></a>11.3.5 编写dao</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProvinceDao</span> &#123;<br>    <span class="hljs-meta">@Select(&quot;select * from province&quot;)</span><br>    List&lt;Province&gt; <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="11-3-6-编写Service"><a href="#11-3-6-编写Service" class="headerlink" title="11.3.6 编写Service"></a>11.3.6 编写Service</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProvinceService</span> &#123;<br>    String <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProvinceServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ProvinceService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    ProvinceDao provinceDao;<br><br>    <span class="hljs-meta">@Autowired</span><br>    JedisPool jedisPool;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//首先从缓存里面获取数据，如果缓存里面能够获取到数据，就直接从缓存里面获取数据即可。</span><br>        <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">province_name</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">&quot;province_name&quot;</span>);<br>        <span class="hljs-keyword">if</span>(StringUtils.isEmpty(province_name))&#123;<br>            <span class="hljs-comment">//如果缓存里面没有数据，从数据库里面取数据</span><br>            List&lt;Province&gt; provinceList = provinceDao.findAll();<br>            <span class="hljs-comment">//将provinceList转换成json串</span><br>            <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>            <span class="hljs-comment">//将java数据类型转换成json数据</span><br>            province_name = mapper.writeValueAsString(provinceList);<br>            <span class="hljs-comment">//将数据放在缓存里面</span><br>            jedis.set(<span class="hljs-string">&quot;province_name&quot;</span>,province_name);<br>            <span class="hljs-keyword">return</span> province_name;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-comment">//缓存里面有数据</span><br>            <span class="hljs-keyword">return</span> province_name;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="11-3-7-编写Controller"><a href="#11-3-7-编写Controller" class="headerlink" title="11.3.7 编写Controller"></a>11.3.7 编写Controller</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;province&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProvinceController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    ProvinceService provinceService;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;findAll&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findAll</span><span class="hljs-params">(HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        response.setContentType(<span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">json_String</span> <span class="hljs-operator">=</span> provinceService.findAll();<br>        <span class="hljs-comment">//向浏览器端响应json数据</span><br>        response.getWriter().write(json_String);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="11-4-springboot整合redis"><a href="#11-4-springboot整合redis" class="headerlink" title="11.4 springboot整合redis"></a>11.4 springboot整合redis</h3><h4 id="11-4-1-创建springboot工程，引入相关依赖"><a href="#11-4-1-创建springboot工程，引入相关依赖" class="headerlink" title="11.4.1 创建springboot工程，引入相关依赖"></a>11.4.1 创建springboot工程，引入相关依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.0.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--web启动器--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- redis --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- spring2.X集成redis所需common-pool2--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-pool2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>
<h4 id="11-4-2-编写启动器"><a href="#11-4-2-编写启动器" class="headerlink" title="11.4.2 编写启动器"></a>11.4.2 编写启动器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(App.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="11-4-3-编写配置文件"><a href="#11-4-3-编写配置文件" class="headerlink" title="11.4.3 编写配置文件"></a>11.4.3 编写配置文件</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">#Redis服务器地址</span><br><span class="hljs-attr">spring.redis.host</span>=<span class="hljs-string">192.168.10.130</span><br><span class="hljs-comment">#Redis服务器连接端口</span><br><span class="hljs-attr">spring.redis.port</span>=<span class="hljs-string">6379</span><br><span class="hljs-comment">#Redis数据库索引（默认为0）</span><br><span class="hljs-attr">spring.redis.database</span>= <span class="hljs-string">0</span><br><span class="hljs-comment">#连接超时时间（毫秒）</span><br><span class="hljs-attr">spring.redis.timeout</span>=<span class="hljs-string">1800000</span><br><span class="hljs-comment">#连接池最大连接数（使用负值表示没有限制）</span><br><span class="hljs-attr">spring.redis.lettuce.pool.max-active</span>=<span class="hljs-string">20</span><br><span class="hljs-comment">#最大阻塞等待时间(负数表示没限制)</span><br><span class="hljs-attr">spring.redis.lettuce.pool.max-wait</span>=<span class="hljs-string">-1</span><br><span class="hljs-comment">#连接池中的最大空闲连接</span><br><span class="hljs-attr">spring.redis.lettuce.pool.max-idle</span>=<span class="hljs-string">5</span><br><span class="hljs-comment">#连接池中的最小空闲连接</span><br><span class="hljs-attr">spring.redis.lettuce.pool.min-idle</span>=<span class="hljs-string">0</span><br></code></pre></td></tr></table></figure>
<h4 id="11-4-3-编写配置类"><a href="#11-4-3-编写配置类" class="headerlink" title="11.4.3 编写配置类"></a>11.4.3 编写配置类</h4><p>配置类是固定的写法，我们直接引入即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xq.config;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.PropertyAccessor;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><span class="hljs-keyword">import</span> org.springframework.cache.CacheManager;<br><span class="hljs-keyword">import</span> org.springframework.cache.annotation.CachingConfigurerSupport;<br><span class="hljs-keyword">import</span> org.springframework.cache.annotation.EnableCaching;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.cache.RedisCacheConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.cache.RedisCacheManager;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.RedisSerializationContext;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.RedisSerializer;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;<br><br><span class="hljs-keyword">import</span> java.time.Duration;<br><br><span class="hljs-meta">@EnableCaching</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CachingConfigurerSupport</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory factory)</span> &#123;<br>        RedisTemplate&lt;String, Object&gt; template = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();<br>        RedisSerializer&lt;String&gt; redisSerializer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>();<br>        <span class="hljs-type">Jackson2JsonRedisSerializer</span> <span class="hljs-variable">jackson2JsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonRedisSerializer</span>(Object.class);<br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">om</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);<br>        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);<br>        jackson2JsonRedisSerializer.setObjectMapper(om);<br>        template.setConnectionFactory(factory);<br>        <span class="hljs-comment">//key序列化方式</span><br>        template.setKeySerializer(redisSerializer);<br>        <span class="hljs-comment">//value序列化</span><br>        template.setValueSerializer(jackson2JsonRedisSerializer);<br>        <span class="hljs-comment">//value hashmap序列化</span><br>        template.setHashValueSerializer(jackson2JsonRedisSerializer);<br>        <span class="hljs-keyword">return</span> template;<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> CacheManager <span class="hljs-title function_">cacheManager</span><span class="hljs-params">(RedisConnectionFactory factory)</span> &#123;<br>        RedisSerializer&lt;String&gt; redisSerializer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>();<br>        <span class="hljs-type">Jackson2JsonRedisSerializer</span> <span class="hljs-variable">jackson2JsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonRedisSerializer</span>(Object.class);<br>        <span class="hljs-comment">//解决查询缓存转换异常的问题</span><br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">om</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);<br>        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);<br>        jackson2JsonRedisSerializer.setObjectMapper(om);<br>        <span class="hljs-comment">// 配置序列化（解决乱码的问题）,过期时间600秒</span><br>        <span class="hljs-type">RedisCacheConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> RedisCacheConfiguration.defaultCacheConfig()<br>                .entryTtl(Duration.ofSeconds(<span class="hljs-number">600</span>))<br>                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(redisSerializer))<br>                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(jackson2JsonRedisSerializer))<br>                .disableCachingNullValues();<br>        <span class="hljs-type">RedisCacheManager</span> <span class="hljs-variable">cacheManager</span> <span class="hljs-operator">=</span> RedisCacheManager.builder(factory)<br>                .cacheDefaults(config)<br>                .build();<br>        <span class="hljs-keyword">return</span> cacheManager;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="11-4-4-编写controller"><a href="#11-4-4-编写controller" class="headerlink" title="11.4.4 编写controller"></a>11.4.4 编写controller</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/redisTest&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@GetMapping</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">testRedis</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//设置值到redis</span><br>        redisTemplate.opsForValue().set(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;eric&quot;</span>);<br>        <span class="hljs-comment">//从redis获取值</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String)redisTemplate.opsForValue().get(<span class="hljs-string">&quot;name&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="12-redis应用问题"><a href="#12-redis应用问题" class="headerlink" title="12 redis应用问题"></a>12 redis应用问题</h2><h3 id="12-1-缓存穿透"><a href="#12-1-缓存穿透" class="headerlink" title="12.1 缓存穿透"></a>12.1 缓存穿透</h3><h4 id="12-1-1-问题描述"><a href="#12-1-1-问题描述" class="headerlink" title="12.1.1 问题描述"></a>12.1.1 问题描述</h4><p>key对应的数据在数据库并不存在，每次针对此key的请求从缓存获取不到，请求都会压到数据源，从而可能压垮数据库。比如用一个不存在的用户id获取用户信息，不论缓存还是数据库都没有，若黑客利用此漏洞进行攻击可能压垮数据库。</p>
<p><img src="20221009192353.png" srcset="/img/loading.gif" lazyload style="zoom:70%"></p>
<h4 id="12-1-2-解决方案"><a href="#12-1-2-解决方案" class="headerlink" title="12.1.2 解决方案"></a>12.1.2 解决方案</h4><p>一个一定不存在缓存及查询不到的数据，由于缓存是不命中时被动写的，并且出于容错考虑，如果从存储层查不到数据则不写入缓存，这将导致这个不存在的数据每次请求都要到存储层去查询，失去了缓存的意义。</p>
<p>解决方案：</p>
<p>（1）  <strong>对空值缓存：</strong>如果一个查询返回的数据为空（不管是数据是否不存在），我们仍然把这个空结果（null）进行缓存，设置空结果的过期时间会很短，最长不超过五分钟</p>
<p>（2）  <strong>设置可访问的名单（白名单）：</strong></p>
<p>使用bitmap类型定义一个可以访问的名单，名单id作为bitmaps的偏移量，每次访问和bitmap里面的id进行比较，如果访问id不在bitmaps里面，进行拦截，不允许访问。</p>
<p>（3）  <strong>采用布隆过滤器</strong>：(布隆过滤器（Bloom Filter）是1970年由布隆提出的。它实际上是一个很长的二进制向量(位图)和一系列随机映射函数（哈希函数）。</p>
<p>布隆过滤器可以用于检索一个元素是否在一个集合中。它的优点是空间效率和查询时间都远远超过一般的算法，缺点是有一定的误识别率和删除困难。)</p>
<p>将所有可能存在的数据哈希到一个足够大的bitmaps中，一个一定不存在的数据会被 这个bitmaps拦截掉，从而避免了对底层存储系统的查询压力。</p>
<p><strong>（4）</strong>  <strong>进行实时监控：</strong>当发现Redis的命中率开始急速降低，需要排查访问对象和访问的数据，和运维人员配合，可以设置黑名单限制服务</p>
<h3 id="12-2-缓存击穿"><a href="#12-2-缓存击穿" class="headerlink" title="12.2 缓存击穿"></a>12.2 缓存击穿</h3><h4 id="12-2-1-问题描述"><a href="#12-2-1-问题描述" class="headerlink" title="12.2.1 问题描述"></a>12.2.1 问题描述</h4><p>key对应的数据存在，但在redis中过期，此时若有大量并发请求过来，这些请求发现缓存过期一般都会从后端DB加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端DB压垮。</p>
<p><img src="20221009200327.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<h4 id="12-2-2-解决方案"><a href="#12-2-2-解决方案" class="headerlink" title="12.2.2 解决方案"></a>12.2.2 解决方案</h4><p>key可能会在某些时间点被超高并发地访问，是一种非常“热点”的数据。这个时候，需要考虑一个问题：缓存被“击穿”的问题。</p>
<p>解决问题：</p>
<p><strong>（1）预先设置热门数据：</strong>在redis高峰访问之前，把一些热门数据提前存入到redis里面，加大这些热门数据key的时长</p>
<p><strong>（2）实时调整：</strong>现场监控哪些数据热门，实时调整key的过期时长</p>
<p><strong>（3）使用锁：</strong></p>
<p>​        （3.1）  就是在缓存失效的时候（判断拿出来的值为空），不是立即去load db。</p>
<p>​        （3.2）  先使用缓存工具的某些带成功操作返回值的操作（比如Redis的SETNX）去set一个mutex key</p>
<p>​        （3.3）  当操作返回成功时，再进行load db的操作，并回设缓存,最后删除mutex key；</p>
<p>​        （3.4）  当操作返回失败，证明有线程在load db，当前线程睡眠一段时间再重试整个get缓存的方法。</p>
<p><img src="20221009200704.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<h3 id="12-3-缓存雪崩"><a href="#12-3-缓存雪崩" class="headerlink" title="12.3 缓存雪崩"></a>12.3 缓存雪崩</h3><h4 id="12-3-1-问题描述"><a href="#12-3-1-问题描述" class="headerlink" title="12.3.1 问题描述"></a>12.3.1 问题描述</h4><p>key对应的数据存在，但在redis中过期，此时若有大量并发请求过来，这些请求发现缓存过期一般都会从后端DB加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端DB压垮。</p>
<p>缓存雪崩与缓存击穿的区别在于这里针对很多key缓存，前者则是某一个key。</p>
<h4 id="12-3-2-解决方案"><a href="#12-3-2-解决方案" class="headerlink" title="12.3.2 解决方案"></a>12.3.2 解决方案</h4><ul>
<li><strong>构建多级缓存架构：</strong>nginx缓存 + redis缓存 +其他缓存（ehcache等）</li>
<li><p>用加锁或者队列的方式保证来保证不会有大量的线程对数据库一次性进行读写，从而避免失效时大量的并发请求落到底层存储系统上。不适用高并发情况</p>
</li>
<li><p>比如我们可以在原有的失效时间基础上增加一个随机值，比如1-5分钟随机，这样每一个缓存的过期时间的重复率就会降低，就很难引发集体失效的事件。</p>
</li>
<li><p>记录缓存数据是否过期（设置提前量），如果过期会触发通知另外的线程在后台去更新实际key的缓存。</p>
</li>
</ul>
<h3 id="12-4-分布式锁"><a href="#12-4-分布式锁" class="headerlink" title="12.4 分布式锁"></a>12.4 分布式锁</h3><h4 id="12-4-1-分布式锁简介"><a href="#12-4-1-分布式锁简介" class="headerlink" title="12.4.1 分布式锁简介"></a>12.4.1 分布式锁简介</h4><p>随着业务发展的需要，原单体单机部署的系统被演化成分布式集群系统后，由于分布式系统多线程、多进程并且分布在不同机器上，这将使原单机部署情况下的并发控制锁策略失效，单纯的Java API并不能提供分布式锁的能力。为了解决这个问题就需要一种跨JVM的互斥机制来控制共享资源的访问，这就是分布式锁要解决的问题！</p>
<p>分布式锁主流的实现方案：</p>
<ol>
<li><p>基于数据库实现分布式锁</p>
</li>
<li><p>基于缓存（Redis等）</p>
</li>
<li><p>基于Zookeeper</p>
</li>
</ol>
<p>每一种分布式锁解决方案都有各自的优缺点：</p>
<ol>
<li><p>性能：redis最高</p>
</li>
<li><p>可靠性：zookeeper最高</p>
</li>
</ol>
<p>这里，我们就基于redis实现分布式锁。</p>
<h4 id="12-4-2-使用redis实现分布式锁的演示"><a href="#12-4-2-使用redis实现分布式锁的演示" class="headerlink" title="12.4.2  使用redis实现分布式锁的演示"></a>12.4.2  使用redis实现分布式锁的演示</h4><p>使用setnx命令实现分布式锁</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; setnx user 10  # 设置成功 并且上锁了<br>(integer) 1<br>127.0.0.1:6379&gt; setnx user 20  # 设置不成功，因为锁没有释放 <br>(integer) 0<br>127.0.0.1:6379&gt; setnx user 30<br>(integer) 0<br>127.0.0.1:6379&gt; del user  # 释放锁<br>(integer) 1<br>127.0.0.1:6379&gt; setnx user 20  # 释放锁成功<br>(integer) 1<br><br></code></pre></td></tr></table></figure>
<p>那这种实现方式有没有什么问题?现在上锁之后，锁都是我们程序员手动释放的。如果我们因为一些原因没有释放锁，那锁就会一直存在。</p>
<p>解决这个问题的方案很简单，就是上锁以后，我们给锁设置一个过期时间，当时间到了之后，锁就自动释放。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; setnx user 10  # 设置锁<br>(integer) 1<br>127.0.0.1:6379&gt; expire user 20  # 设置锁的过期时间 20秒<br>(integer) 1<br>127.0.0.1:6379&gt; setnx user 20<br>(integer) 0<br>127.0.0.1:6379&gt; ttl user<br>(integer) 12<br>127.0.0.1:6379&gt; setnx user 5  # 锁没有过期 所以设置值失败<br>(integer) 0<br>127.0.0.1:6379&gt; setnx user 5  # 锁过期了，所以值设置成功<br>(integer) 1<br></code></pre></td></tr></table></figure>
<p>现在我们设置锁，并且设置锁的失效时间是由两个命令实现的。并不具备原子性。如果上锁成功，还没来得及设置锁的过期时间，redis服务就挂掉了，那锁的失效时间还是没有设置成功，如何解决?</p>
<p>我们可以在上锁的同时设置过期时间。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; set user 10 nx ex 20  # 上锁的同时 设置过期时间是20<br>OK<br>127.0.0.1:6379&gt; ttl user<br>(integer) 17<br>127.0.0.1:6379&gt; setnx user 20  # 锁没有释放 设置值失败<br>(integer) 0<br>127.0.0.1:6379&gt; setnx user 18<br>(integer) 0<br>127.0.0.1:6379&gt; ttl user<br>(integer) 7<br>127.0.0.1:6379&gt; setnx user 10 # 锁释放 设置值成功<br>(integer) 1<br></code></pre></td></tr></table></figure>
<h4 id="12-4-3-使用java代码实现分布式锁"><a href="#12-4-3-使用java代码实现分布式锁" class="headerlink" title="12.4.3 使用java代码实现分布式锁"></a>12.4.3 使用java代码实现分布式锁</h4><ul>
<li>前期准备工作：</li>
</ul>
<p>在redis里面设置num = 0</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; set num 0<br></code></pre></td></tr></table></figure>
<p>在redis里面安装ab工具，用来并发测试我们的请求。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">[qgc@qgc-virtual-machine]~$ </span><span class="language-bash">yum install httpd-tools</span><br></code></pre></td></tr></table></figure>
<ul>
<li>编写java代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;testLock&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testLock</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">//1获取锁</span><br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(<span class="hljs-string">&quot;lock&quot;</span>, <span class="hljs-string">&quot;111&quot;</span>);<span class="hljs-comment">//setnx lock 111</span><br>    /<span class="hljs-number">2</span>获取锁成功、查询num的值<br>    <span class="hljs-keyword">if</span>(lock)&#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(<span class="hljs-string">&quot;num&quot;</span>);<br>        /<span class="hljs-number">2.1</span>判断num为空<span class="hljs-keyword">return</span><br>        <span class="hljs-keyword">if</span>(StringUtils.isEmpty(value))&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        /<span class="hljs-number">2.2</span>有值就转成成<span class="hljs-type">int</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> Integer.parseInt(value+<span class="hljs-string">&quot;&quot;</span>);<br>        /<span class="hljs-number">2.3</span>把redis的num加<span class="hljs-number">1</span><br>        redisTemplate.opsForValue().set(<span class="hljs-string">&quot;num&quot;</span>, ++num);<br>        /<span class="hljs-number">2.4</span>释放锁，del<br>        redisTemplate.delete(<span class="hljs-string">&quot;lock&quot;</span>);<br><br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-comment">//3获取锁失败、每隔0.1秒再获取</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">100</span>);<br>            testLock();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>在linux里面执行下面请求：</li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs txt">ab -n 1000 -c 100 http://192.168.1.3:8080/redisTest/testLock<br>1000: 1000次请求<br>100: 每次请求的并发数是100<br>192.168.1.3  本机的ip地址<br></code></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">[qgc@qgc-virtual-machine]~$ </span><span class="language-bash">ab -n 1000 -c 100 http://192.168.1.3:8080/redisTest/testLock</span><br></code></pre></td></tr></table></figure>
<p>执行完毕，查看num的结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">127.0.0.1:6379&gt; get num<br>&quot;1000&quot;  # 演示出了分布式锁的效果<br></code></pre></td></tr></table></figure>
<p><strong>问题：setnx刚好获取到锁，业务逻辑出现异常，导致锁无法释放。</strong></p>
<p><strong>解决：设置过期时间，自动释放锁。</strong></p>
<p><img src="20221009221846.png" srcset="/img/loading.gif" lazyload></p>
<p>压力测试肯定也没有问题。</p>
<p><strong>问题：锁存在被误删的情况</strong></p>
<p><img src="20221009222539.png" srcset="/img/loading.gif" lazyload style="zoom:70%"></p>
<p><strong>解决方案：使用UUID防止误删</strong></p>
<p>每次释放锁操作的时候，都拿到当前的uuid和锁的uuid进行比对，如果一致才允许释放锁。</p>
<p><img src="20221009223003.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>问题：锁删除操作不具备原子性！！！</strong></p>
<h4 id="12-4-4-使用lua脚本保证锁删除的原子性"><a href="#12-4-4-使用lua脚本保证锁删除的原子性" class="headerlink" title="12.4.4 使用lua脚本保证锁删除的原子性"></a>12.4.4 使用lua脚本保证锁删除的原子性</h4><p>由于锁删除操作不具备原子性，还是会出现锁的误删操作。</p>
<p><img src="20221009231238.png" srcset="/img/loading.gif" lazyload style="zoom:80%"></p>
<p><strong>解决方案：使用lua脚本优化代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;testLockLua&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testLockLua</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//1 声明一个uuid ,将做为一个value 放入我们的key所对应的值中</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">uuid</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();<br>    /<span class="hljs-number">2</span> 定义一个锁：lua 脚本可以使用同一把锁，来实现删除！<br>    <span class="hljs-comment">// 3 获取锁</span><br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(<span class="hljs-string">&quot;lock&quot;</span>, uuid, <span class="hljs-number">3</span>, TimeUnit.SECONDS);<br>    <span class="hljs-comment">// 如果true</span><br>    <span class="hljs-keyword">if</span> (lock) &#123;<br>        <span class="hljs-comment">// 执行的业务逻辑开始</span><br>        <span class="hljs-comment">// 获取缓存中的num 数据</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(<span class="hljs-string">&quot;num&quot;</span>);<br>        <span class="hljs-comment">// 如果是空直接返回</span><br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(value)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// 不是空 如果说在这出现了异常！ 那么delete 就删除失败！ 也就是说锁永远存在！</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> Integer.parseInt(value + <span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-comment">// 使num 每次+1 放入缓存</span><br>        redisTemplate.opsForValue().set(<span class="hljs-string">&quot;num&quot;</span>, ++num);<br>        <span class="hljs-comment">/*使用lua脚本来锁*/</span><br>        <span class="hljs-comment">// 定义lua 脚本</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;if redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;, KEYS[1]) else return 0 end&quot;</span>;<br>        <span class="hljs-comment">// 使用redis执行lua执行</span><br>        DefaultRedisScript&lt;Long&gt; redisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();<br>        redisScript.setScriptText(script);<br>        <span class="hljs-comment">// 设置一下返回值类型 为Long</span><br>        <span class="hljs-comment">// 因为删除判断的时候，返回的0,给其封装为数据类型。如果不封装那么默认返回String 类型，</span><br>        <span class="hljs-comment">// 那么返回字符串与0 会有发生错误。</span><br>        redisScript.setResultType(Long.class);<br>        <span class="hljs-comment">// 第一个要是script 脚本 ，第二个需要判断的key，第三个就是key所对应的值。</span><br>        redisTemplate.execute(redisScript, Arrays.asList(<span class="hljs-string">&quot;lock&quot;</span>), uuid);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 其他线程等待</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 睡眠</span><br>            Thread.sleep(<span class="hljs-number">100</span>);<br>            <span class="hljs-comment">// 睡醒了之后，调用方法。</span><br>            testLockLua();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>总结：</p>
<p>为了确保分布式锁可用，我们至少要确保锁的实现同时<strong>满足以下四个条件</strong>：</p>
<ul>
<li><p><strong>互斥性。在任意时刻，只有一个客户端能持有锁。</strong></p>
</li>
<li><p><strong>不会发生死锁。即使有一个客户端在持有锁的期间崩溃而没有主动解锁，也能保证后续其他客户端能加锁。</strong></p>
</li>
<li><p><strong>解铃还须系铃人。加锁和解锁必须是同一个客户端，客户端自己不能把别人加的锁给解了。</strong></p>
</li>
<li><p><strong>加锁和解锁必须具有原子性。</strong></p>
</li>
</ul>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Java%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB/" class="category-chain-item">Java知识体系</a>
  
  
    <span>></span>
    
  <a href="/categories/Java%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB/%E4%B8%AD%E9%97%B4%E4%BB%B6/" class="category-chain-item">中间件</a>
  
  
    <span>></span>
    
  <a href="/categories/Java%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB/%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis/" class="category-chain-item">Redis</a>
  
  

  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Redis/">#Redis</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Redis</div>
      <div>http://example.com/2023/09/02/redis/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>子川</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年9月2日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/09/03/Java%E5%9F%BA%E7%A1%80%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98%E6%80%BB%E7%BB%93-%E4%B8%AD/" title="Java基础常见面试题总结(中)">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Java基础常见面试题总结(中)</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/08/30/Java%E5%9F%BA%E7%A1%80%E9%9D%A2%E8%AF%95(%E4%B8%8A)/" title="JJava基础常见面试题总结(上)">
                        <span class="hidden-mobile">JJava基础常见面试题总结(上)</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
